<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<title>P.E.I.P. åˆ†é¡ã‚¯ã‚¤ã‚º</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<style>
  body { font-family: sans-serif; background:#f4f4f4; margin:0; }
  h1 { margin:0; padding:16px; text-align:center; background:#fff; color:#444; position:sticky; top:0; z-index:5; }

  /* ãƒˆãƒƒãƒ—ãƒãƒ¼ï¼ˆéŸ³å£°ãƒˆã‚°ãƒ«ï¼‹ãƒ›ãƒ¼ãƒ ï¼‰ */
  .topbar {
    display:flex; justify-content:center; align-items:center; gap:12px;
    background:#fff; padding:8px 10px; border-bottom:1px solid #eee;
    position:sticky; top:56px; z-index:5; flex-wrap:wrap;
  }
  .sound-toggle {
    display:inline-flex; align-items:center; gap:8px; padding:6px 10px;
    border-radius:999px; background:#fff; border:1px solid #ddd;
  }
  .sound-toggle input { width:20px; height:20px; }
  #soundLabel { font-weight:600; }
  #homeBtnTop {
    margin-left:8px; padding:8px 12px; border:none; border-radius:10px; cursor:pointer;
    background:#6c757d; color:#fff; display:none;
  }

  /* ã‚¹ã‚¿ãƒ¼ãƒˆç”»é¢ */
  #startArea { padding:16px; }
  #top10Box { max-width:900px; margin: 10px auto; background:#fff; border-radius:10px; padding:14px; }
  #startButtons { text-align:center; margin:18px 0; }
  #startButton { background:#ff69b4; color:#fff; border:none; padding:14px 36px; font-size:18px; border-radius:12px; cursor:pointer; }

  /* æƒ…å ±ãƒãƒ¼ï¼ˆã‚²ãƒ¼ãƒ ä¸­ï¼‰ */
  .info { display:flex; justify-content:center; align-items:center; gap:16px; flex-wrap:wrap; margin:10px; }
  .badge { display:inline-block; padding:4px 10px; border-radius:999px; font-weight:700; }
  .elapsed-badge { background:#e3f7ff; border:2px solid #5bc0de; color:#0b6d85; }
  .acc-badge { background:#fff6e0; border:2px solid #f0ad4e; color:#856404; }

  /* å•é¡Œã¨å›ç­”ãƒœã‚¿ãƒ³ */
  .question { text-align:center; font-size:22px; margin:10px 12px; }
  .buttons { display:flex; flex-wrap:wrap; justify-content:center; gap:14px; margin:12px; }
  .btn-circle{
    width: 132px; height:132px; border-radius:50%;
    display:flex; align-items:center; justify-content:center;
    border:none; cursor:pointer; color:#fff; box-shadow:0 4px 12px rgba(0,0,0,.08);
  }
  .btn-circle .btn-content{ display:flex; flex-direction:column; align-items:center; line-height:1.2; }
  .line1{ font-size:1.1em; font-weight:800; }
  .line2,.line3{ font-size:.85em; font-weight:700; opacity:.95; }

  .P{ background:#e74c3c; }             /* ãã‚‚ã¡ãƒ»èµ¤ */
  .E{ background:#3498db; }             /* ã¾ã‚ã‚Šãƒ»é’ */
  .I{ background:#f1c40f; color:#333; } /* ã§ãã‚‹ã“ã¨ãƒ»é»„ï¼ˆæ¿ƒæ–‡å­—ï¼‰ */
  .Ph{ background:#2ecc71; }            /* ã‹ã‚‰ã ãƒ»ç·‘ */

  .result { text-align:center; font-size:18px; min-height:1.6em; margin:8px 0; }

  /* ãƒ©ãƒ³ã‚­ãƒ³ã‚°è¡¨ */
  table { width:100%; border-collapse:collapse; }
  th, td { padding:8px; border-bottom:1px solid #e9e9e9; }
  th { background:#fafafa; text-align:left; }
  .num { text-align:right; }
  .crown { font-size:32px; } /* ç‹å† å¤§ãã‚ */
  .gold   { color: #ffd400; } /* 1ä½ï¼šé»„è‰² */
  .silver { color: #9e9e9e; } /* 2ä½ï¼šç°è‰² */
  .bronze { color: #8b4513; } /* 3ä½ï¼šèŒ¶è‰² */

  /* çµæœ */
  #finalReport { max-width:900px; margin:16px auto; background:#fff; border-radius:10px; padding:14px; display:none; }
  #finalReport h3{ margin-top:0; }
  .report-item { margin:8px 0; }
  .wrong { color:#d9534f; }
  .correct { color:#2e7d32; }

  /* æ±ç”¨ãƒœã‚¿ãƒ³ */
  .btn { padding:10px 16px; border:none; border-radius:10px; cursor:pointer; }
  .btn-primary { background:#007bff; color:#fff; }
  .btn-success { background:#28a745; color:#fff; }
  .btn-secondary { background:#6c757d; color:#fff; }
  .btn-danger { background:#dc3545; color:#fff; }
  .btn-link { background:transparent; color:#007bff; text-decoration:underline; cursor:pointer; border:none; }

  /* ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ï¼ˆã‚²ãƒ¼ãƒ ä¸­ï¼‰ */
  #controlRow { display:flex; justify-content:center; gap:12px; margin:12px; }
  #pauseBtn { }
  #quitBtn { }

  /* ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³ãƒ»ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ï¼ˆãƒ•ã‚§ãƒ¼ãƒ‰ç„¡ã—ãƒ»æ‹¡å¤§ã®ã¿ï¼‰ */
  #countOverlay{
    position:fixed; inset:0; display:none; align-items:center; justify-content:center;
    background:rgba(0,0,0,.65); color:#fff; z-index:9999;
    font-weight:900; text-shadow:0 4px 14px rgba(0,0,0,.6); user-select:none;
    font-size:120px;
  }
  #countText { display:block; }
  @keyframes popscale {
    0%   { transform:scale(.7); }
    60%  { transform:scale(1.15); }
    100% { transform:scale(1.0); }
  }
  .pop { animation: popscale .35s ease-out; }
</style>
</head>
<body>
  <h1>P.E.I.P. åˆ†é¡ã‚¯ã‚¤ã‚º</h1>

  <!-- ãƒˆãƒƒãƒ—ãƒãƒ¼ï¼šéŸ³å£°ãƒˆã‚°ãƒ«ï¼†ã‚¹ã‚¿ãƒ¼ãƒˆã¸æˆ»ã‚‹ -->
  <div class="topbar">
    <label class="sound-toggle" title="åŠ¹æœéŸ³ ON/OFF">
      <input type="checkbox" id="soundToggle" checked />
      <span id="soundLabel">éŸ³å£°: ON</span>
    </label>
    <button id="homeBtnTop" class="btn btn-secondary" onclick="goHome()">ğŸ  ã‚¹ã‚¿ãƒ¼ãƒˆç”»é¢ã«æˆ»ã‚‹</button>
  </div>

  <!-- ã‚¹ã‚¿ãƒ¼ãƒˆç”»é¢ï¼ˆTOP10ã‚’è¡¨ç¤ºï¼‰ -->
  <div id="startArea">
    <div style="text-align:center; margin:8px 0;">
      <h2 style="margin:6px 0;">ãƒ©ãƒ³ã‚­ãƒ³ã‚° TOP10ï¼ˆã‚¿ã‚¤ãƒ ãŒçŸ­ã„é †ï¼‰</h2>
      <small>â€» 50å•å®Œèµ°è€…ã®ä¸­ã‹ã‚‰ã€ã‚¿ã‚¤ãƒ â†’æ­£è§£æ•°â†’æ—¥æ™‚ã§ä¸¦ã¹ã¦ã„ã¾ã™</small>
    </div>
    <div id="top10Box">èª­ã¿è¾¼ã¿ä¸­...</div>
    <div id="startButtons">
      <button id="startButton" class="btn btn-primary" onclick="startCountdown()">ã‚¹ã‚¿ãƒ¼ãƒˆ</button>
    </div>
  </div>

  <!-- ã‚²ãƒ¼ãƒ ç”»é¢ -->
  <div id="gameArea" style="display:none;">
    <div class="info">
      <span>ã‚¹ã‚³ã‚¢: <strong id="score">0</strong></span>
      <span>å•é¡Œ: <strong id="questionNumber">0</strong> / <strong id="totalQuestions">0</strong></span>
      <span class="badge elapsed-badge">çµŒéæ™‚é–“: <strong id="elapsed">0.00</strong> ç§’</span>
      <span class="badge acc-badge">æ­£è§£ç‡: <strong id="accuracy">0.0%</strong></span>
    </div>

    <div class="question" id="question">å•é¡Œã‚’èª­ã¿è¾¼ã¿ä¸­...</div>

    <div class="buttons" id="answerButtons">
      <button class="btn-circle P" onclick="checkAnswer('P')">
        <span class="btn-content">
          <span class="line1">ãã‚‚ã¡</span>
          <span class="line2">Personality</span>
          <span class="line3">å€‹äºº</span>
        </span>
      </button>
      <button class="btn-circle E" onclick="checkAnswer('E')">
        <span class="btn-content">
          <span class="line1">ã¾ã‚ã‚Š</span>
          <span class="line2">Environment</span>
          <span class="line3">ç’°å¢ƒ</span>
        </span>
      </button>
      <button class="btn-circle I" onclick="checkAnswer('I')">
        <span class="btn-content">
          <span class="line1">ã§ãã‚‹ã“ã¨</span>
          <span class="line2">Independence</span>
          <span class="line3">è‡ªç«‹</span>
        </span>
      </button>
      <button class="btn-circle Ph" onclick="checkAnswer('Ph')">
        <span class="btn-content">
          <span class="line1">ã‹ã‚‰ã ï¼†ç—…æ°—</span>
          <span class="line2">Physical</span>
          <span class="line3">èº«ä½“</span>
        </span>
      </button>
    </div>

    <div class="result" id="result"></div>

    <div id="controlRow">
      <button id="pauseBtn" class="btn btn-secondary" onclick="togglePause()">â¸ ä¸€æ™‚åœæ­¢</button>
      <button id="quitBtn"  class="btn btn-danger" onclick="quitGame()">â¹ ã‚„ã‚ã‚‹</button>
      <button class="btn btn-secondary" onclick="goHome()">ğŸ  ã‚¹ã‚¿ãƒ¼ãƒˆç”»é¢ã«æˆ»ã‚‹</button>
    </div>
  </div>

  <!-- çµæœè¡¨ç¤º -->
  <div id="finalReport"></div>

  <!-- åŠ¹æœéŸ³ -->
  <audio id="correctSound"   src="se_correct.mp3"  preload="auto"></audio>
  <audio id="wrongSound"     src="se_wrong.mp3"    preload="auto"></audio>
  <audio id="countdownSound" src="countdown.mp3"   preload="auto"></audio>

  <!-- ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³è¡¨ç¤º -->
  <div id="countOverlay"><span id="countText">3</span></div>

  <!-- Firebaseï¼ˆFirestoreï¼‰ -->
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>

  <script>
  /**********************
   * Firebase è¨­å®šï¼ˆã‚ãªãŸã®å®Ÿãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆï¼‰
   **********************/
  const firebaseConfig = {
    apiKey: "AIzaSyARGroRdf4DmJN5nOHdiVy-a9UCA1ruDPw",
    authDomain: "peip-quiz.firebaseapp.com",
    projectId: "peip-quiz",
    storageBucket: "peip-quiz.appspot.com",
    messagingSenderId: "523666051548",
    appId: "1:523666051548:web:2a84fc0f2163872b2eff19",
    measurementId: "G-6049XMQEBK"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();

  /**********************
   * è¡¨ç¤ºãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
   **********************/
  const labelMap = { P:"ãã‚‚ã¡", E:"ã¾ã‚ã‚Š", I:"ã§ãã‚‹ã“ã¨", Ph:"ã‹ã‚‰ã ï¼†ç—…æ°—" };

  const crown = (rank)=>{
    if(rank===1) return `<span class="crown gold">ğŸ‘‘</span>`;
    if(rank===2) return `<span class="crown silver">ğŸ‘‘</span>`;
    if(rank===3) return `<span class="crown bronze">ğŸ‘‘</span>`;
    return rank;
  };
  const fmtTime = (sec)=> (Number(sec)||0).toFixed(2) + "s";
  const fmtDate = (iso)=>{
    try{
      const d=new Date(iso);
      const z=n=>String(n).padStart(2,'0');
      // ç§’ã¯ä¸è¦ã®ã”è¦æœ›ï¼šåˆ†ã¾ã§
      return `${d.getFullYear()}-${z(d.getMonth()+1)}-${z(d.getDate())} ${z(d.getHours())}:${z(d.getMinutes())}`;
    }catch{return "";}
  };
  const esc = (s)=>String(s||"").replace(/[&<>"'`=\/]/g,c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;','/':'&#x2F;','=':'&#x3D;','`':'&#x60;' }[c]));

  /**********************
   * ãƒ©ãƒ³ã‚­ãƒ³ã‚°ï¼ˆå®Œèµ°è€…ãƒ»ã‚¿ã‚¤ãƒ æ˜‡é †ï¼‰
   * ä¸¦ã³é †ï¼štime asc â†’ correct desc â†’ createdAt asc
   **********************/
  async function fetchTop10ByTime(){
    const snap = await db.collection('scores')
      .orderBy('time','asc')
      .orderBy('correct','desc')
      .orderBy('createdAt','asc')
      .limit(10)
      .get();
    const list=[]; snap.forEach(d=>list.push({ id:d.id, ...d.data() }));
    return list;
  }

  async function renderTop10(){
    const box=document.getElementById('top10Box');
    box.textContent="èª­ã¿è¾¼ã¿ä¸­...";
    try{
      const rows=await fetchTop10ByTime();
      if(!rows.length){ box.textContent="ã¾ã è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“"; return; }
      let html = `<table>
        <thead>
          <tr><th>é †ä½</th><th>åå‰</th><th class="num">æ­£è§£</th><th class="num">ã‚¿ã‚¤ãƒ </th><th>æ—¥æ™‚</th><th>ã‚³ãƒ¡ãƒ³ãƒˆ</th></tr>
        </thead><tbody>`;
      rows.forEach((r,i)=>{
        html += `<tr>
          <td>${crown(i+1)}</td>
          <td>${esc(r.name)||"åç„¡ã—"}</td>
          <td class="num">${Number(r.correct)||0}</td>
          <td class="num">${fmtTime(r.time)}</td>
          <td>${fmtDate(r.createdAtLocal)}</td>
          <td>${esc(r.comment)||""}</td>
        </tr>`;
      });
      html += `</tbody></table>`;
      box.innerHTML = html;
    }catch(e){
      console.error(e);
      box.textContent="ãƒ©ãƒ³ã‚­ãƒ³ã‚°å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚";
    }
  }

  /**********************
   * å•é¡Œï¼ˆ50å•ï¼‰
   **********************/
  const questions = [
    { text: "å­«ã«ä¼šã„ãŸã„ã¨æ€ã£ã¦ã„ã‚‹ã‹ï¼Ÿ", answer: "P" },
    { text: "æ´—æ¿¯ç‰©ã«ã—ã‚ã¯ã‚ã‚‹ã‹ï¼Ÿ", answer: "E" },
    { text: "ãƒˆã‚¤ãƒ¬ã§ç«‹ä½ã‚’ã¨ã‚‹ã“ã¨ãŒã§ãã‚‹ã‹ï¼Ÿ", answer: "I" },
    { text: "ä¾¿ç§˜ã¯ãªã„ã‹ï¼Ÿ", answer: "Ph" },
    { text: "æœé£Ÿã®é£²ã¿ç‰©ã«ã“ã ã‚ã‚Šã¯ã‚ã‚‹ã‹ï¼Ÿ", answer: "P" },
    { text: "å±…å®¤ã®æ‰‹ã™ã‚Šã«ãã‚‰ã¤ãã¯ãªã„ã‹ï¼Ÿ", answer: "E" },
    { text: "ä¸€äººã§æ­¯ç£¨ãã¯ã§ãã‚‹ã‹ï¼Ÿ", answer: "I" },
    { text: "ã‚€ã›ã“ã¿ã¯ãªã„ã‹ï¼Ÿ", answer: "Ph" },
    { text: "ãƒ‡ã‚¤ã‚µãƒ¼ãƒ“ã‚¹ã‚’æ¥½ã—ã¿ã«ã—ã¦ã„ã‚‹ã‹ï¼Ÿ", answer: "P" },
    { text: "å†·è”µåº«ã®ä¸­ã«æ¶ˆè²»æœŸé™ãŒéããŸé£Ÿå“ã¯ãªã„ã‹ï¼Ÿ", answer: "E" },
    { text: "æ­©è¡Œå™¨ã‚’ä½¿ãˆã°è‡ªç«‹æ­©è¡Œã¯ã§ãã‚‹ã‹ï¼Ÿ", answer: "I" },
    { text: "è¶³ã«ã‚€ãã¿ã¯ãªã„ã‹ï¼Ÿ", answer: "Ph" },
    { text: "å¥½ããªéŸ³æ¥½ã¯ä½•ã‹ï¼Ÿ", answer: "P" },
    { text: "æ´—é¢æ‰€ã®åºŠã¯æ¿¡ã‚Œã¦ã„ãªã„ã‹ï¼Ÿ", answer: "E" },
    { text: "ãƒˆã‚¤ãƒ¬ã®ãƒœã‚¿ãƒ³ã‚’æ“ä½œã™ã‚‹ã“ã¨ã¯ã§ãã‚‹ã‹ï¼Ÿ", answer: "I" },
    { text: "è‚Œã¯ä¹¾ç‡¥ã—ã¦ã„ãªã„ã‹ï¼Ÿ", answer: "Ph" },
    { text: "å¤–å‡ºã§ãã‚‹ã‚ˆã†ã«ãªã‚ŠãŸã„ã¨ã„ã†å¸Œæœ›ã¯ã‚ã‚‹ã‹ï¼Ÿ", answer: "P" },
    { text: "å±…å®¤ã®ãƒ™ãƒƒãƒ‰ã¯ä»‹åŠ©ç”¨ãƒ™ãƒƒãƒ‰ã‹ï¼Ÿ", answer: "E" },
    { text: "è‡ªåˆ†ã§ç€æ›¿ãˆã¯ã§ãã‚‹ã‹ï¼Ÿ", answer: "I" },
    { text: "é£Ÿæ¬²ã®æœ‰ç„¡", answer: "Ph" },
    { text: "æ˜”ã—ã¦ã„ãŸä»•äº‹ã¯ä½•ã‹ï¼Ÿ", answer: "P" },
    { text: "ä»Šä½¿ç”¨ã—ã¦ã„ã‚‹ç¦ç¥‰ç”¨å…·ã¯ä½•ã‹ï¼Ÿ", answer: "E" },
    { text: "è‡ªåˆ†ã§é›»è©±ã‚’ã‹ã‘ã‚‹ã“ã¨ãŒã§ãã‚‹ã‹ï¼Ÿ", answer: "I" },
    { text: "è¦–åŠ›ã¯ã©ã®ç¨‹åº¦ã‹ï¼Ÿ", answer: "Ph" },
    { text: "é£Ÿã¹ãŸã„ã‚‚ã®ã¯ã‚ã‚‹ã‹ï¼Ÿ", answer: "P" },
    { text: "è‡ªå®…ã§10ãƒŸãƒªä»¥ä¸Šã®æ®µå·®ãŒã‚ã‚‹ã®ã¯ã©ã“ã‹ï¼Ÿ", answer: "E" },
    { text: "è‡ªåˆ†ã§ãŠèŒ¶ã‚’å…¥ã‚Œã¦é£²ã‚€ã“ã¨ã¯ã§ãã‚‹ã‹ï¼Ÿ", answer: "I" },
    { text: "å¤œé–“ã®é »å°¿ã®æœ‰ç„¡", answer: "Ph" },
    { text: "ç¿’æ…£ã¨ãªã£ã¦ã„ã‚‹ã“ã¨ã¯ä½•ã‹ï¼Ÿ", answer: "P" },
    { text: "ä»‹è­·ä¿é™ºåˆ¶åº¦ã§åˆ©ç”¨ã—ã¦ã„ã‚‹ã‚µãƒ¼ãƒ“ã‚¹ã¯ä½•ã‹ï¼Ÿ", answer: "E" },
    { text: "æœã®ä½“æ“ã§ä½“ã‚’å‹•ã‹ã™ã“ã¨ã¯ã§ãã¦ã„ã‚‹ã‹ï¼Ÿ", answer: "I" },
    { text: "ãµã‚‰ã¤ãã¯ãªã„ã‹ï¼Ÿ", answer: "I" }, /* è‡ªç«‹ã«å¤‰æ›´æ¸ˆã¿ */
    { text: "è¶£å‘³ï¼ˆç·¨ã¿ç‰©ï¼‰ã‚’å†é–‹ã—ãŸã„ã¨ã„ã†æ€ã„ã¯ã‚ã‚‹ã‹ï¼Ÿ", answer: "P" },
    { text: "å±…å®¤ã®æ¸©åº¦ãƒ»å®¤æ¸©ã¯ï¼Ÿ", answer: "E" },
    { text: "è‡ªåˆ†ã§é£Ÿäº‹ã‚’æº–å‚™ã™ã‚‹ã“ã¨ã¯ã§ãã‚‹ã‹ï¼Ÿ", answer: "I" },
    { text: "è…°ç—›ãªã©ä½“ã®ç—›ã¿ã¯ãªã„ã‹ï¼Ÿ", answer: "Ph" },
    { text: "èª¿å‘³æ–™ã«ã“ã ã‚ã‚Šã¯ã‚ã‚‹ã‹ï¼Ÿ", answer: "P" },
    { text: "ãƒ†ãƒ¬ãƒ“ã®ãƒœãƒªãƒ¥ãƒ¼ãƒ ã¯ã„ãã¤ã‹ï¼Ÿ", answer: "E" },
    { text: "è‡ªåˆ†ã§è–¬ã¯ç®¡ç†ã§ãã¦ã„ã‚‹ã‹ï¼Ÿ", answer: "I" },
    { text: "ã¾ã¶ãŸã«ç›®ã‚„ã«ã¯ã¤ã„ã¦ã„ãªã„ã‹ï¼Ÿ", answer: "Ph" },
    { text: "ã©ã®ã‚ˆã†ãªç’°å¢ƒã§å¯ãŸã„æ€ã£ã¦ã„ã‚‹ã‹ï¼Ÿ", answer: "P" },
    { text: "ãƒ™ãƒƒãƒ‰ã‚µã‚¤ãƒ‰ã«ã‚³ãƒ¼ãƒ«ãƒœã‚¿ãƒ³ãªã©ã®æœ‰ç„¡", answer: "E" },
    { text: "è‚˜ãªã—ã®æ¤…å­ã§ã‚‚åº§ä½ã‚’ã¨ã‚‹ã“ã¨ã¯ã§ãã¦ã„ã‚‹ã‹ï¼Ÿ", answer: "I" },
    { text: "å·»ãçˆªã¯ãªã„ã‹ï¼Ÿ", answer: "Ph" },
    { text: "ä½•ã‚’ã—ã¦ã„ã‚‹æ™‚ãŒå¹¸ã›ã‚’æ„Ÿã˜ã‚‹æ™‚ã‹ï¼Ÿ", answer: "P" },
    { text: "è¿‘æ‰€ã®äººã¨ã®äº¤æµã¯ã‚ã‚‹ã‹ï¼Ÿ", answer: "E" },
    { text: "è²·ã„ç‰©ãƒªã‚¹ãƒˆã‚’è‡ªåˆ†ã§æ›¸ãã“ã¨ã¯ã§ãã‚‹ã‹ï¼Ÿ", answer: "I" },
    { text: "å¤œé–“ã«ä¸çœ ã®æœ‰ç„¡", answer: "Ph" },
    { text: "é£Ÿäº‹ã®éš›ã«ã“ã ã‚ã‚Šã®é£Ÿå™¨ã‚„å ´æ‰€ã¯ã‚ã‚‹ã‹ï¼Ÿ", answer: "P" },
    { text: "å±…å®¤ã®æ›æ°—çŠ¶æ³", answer: "E" }
  ];

  /**********************
   * ã‚²ãƒ¼ãƒ çŠ¶æ…‹
   **********************/
  let current = 0;
  let score = 0;
  let startTime = 0;
  let elapsedTimer = null;
  let penaltyTime = 0; // ä¸æ­£è§£ãƒšãƒŠãƒ«ãƒ†ã‚£ï¼ˆmsï¼‰
  let wrongList = [];
  let paused = false;
  let pauseStart = 0;
  let totalPaused = 0;
  let soundEnabled = true;

  // éŸ³å£°ON/OFF
  const soundToggle = document.getElementById('soundToggle');
  const soundLabel  = document.getElementById('soundLabel');
  soundToggle.addEventListener('change', ()=>{
    soundEnabled = soundToggle.checked;
    soundLabel.textContent = soundEnabled ? 'éŸ³å£°: ON' : 'éŸ³å£°: OFF';
  });

  function playSE(id){
    if(!soundEnabled) return;
    const el = document.getElementById(id);
    try{ el.currentTime=0; el.play(); }catch(e){}
  }

  function shuffle(a){ for(let i=a.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]]; } }

  /**********************
   * ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³ï¼ˆéŸ³ã¨åŒæœŸãƒ»æ‹¡å¤§ã®ã¿ãƒ»ã€Œã‚¹ã‚¿ãƒ¼ãƒˆï¼ã€ã¯1.8ç§’è¡¨ç¤ºï¼‰
   **********************/
  const COUNTDOWN_MARKERS = [
    { time: 0.00, label: "3" },
    { time: 0.90, label: "2" },
    { time: 1.80, label: "1" },
    { time: 2.65, label: "ã‚¹ã‚¿ãƒ¼ãƒˆï¼" }
  ];
  const HOLD_AFTER_START = 1.80; // 1.8ç§’ä¿æŒ
  const EPS = 0.015;

  function startCountdown(){
    // ã‚¹ã‚¿ãƒ¼ãƒˆç”»é¢ TOP10 ã¯è¦‹ã›ãŸã¾ã¾ã€ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ã ã‘å‡ºã™
    const cd = document.getElementById("countdownSound");
    const overlay = document.getElementById("countOverlay");
    const text = document.getElementById("countText");
    document.getElementById("startButton").disabled = true;
    overlay.style.display="flex";

    let idx = 0;
    const lastMarker = COUNTDOWN_MARKERS[COUNTDOWN_MARKERS.length-1].time;
    const endTime = lastMarker + HOLD_AFTER_START + 0.05;

    const showLabel = (s)=>{
      if (text.textContent === s) return;
      text.textContent = s;
      text.classList.remove('pop'); void text.offsetWidth; text.classList.add('pop');
    };

    const begin = ()=>{
      const startTs = performance.now();

      if (soundEnabled) {
        try { cd.currentTime = 0; cd.play().catch(()=>{}); } catch(e){}

        const tick = ()=>{
          const elapsed = (performance.now() - startTs)/1000;
          const t = cd.currentTime || elapsed;
          while (idx < COUNTDOWN_MARKERS.length && t + EPS >= COUNTDOWN_MARKERS[idx].time) {
            showLabel(COUNTDOWN_MARKERS[idx].label);
            idx++;
          }
          if (elapsed < endTime) {
            requestAnimationFrame(tick);
          } else {
            overlay.style.display = "none";
            beginGame();
          }
        };
        tick();
      } else {
        const tick = ()=>{
          const t = (performance.now() - startTs)/1000;
          while (idx < COUNTDOWN_MARKERS.length && t + EPS >= COUNTDOWN_MARKERS[idx].time) {
            showLabel(COUNTDOWN_MARKERS[idx].label);
            idx++;
          }
          if (t < endTime) {
            requestAnimationFrame(tick);
          } else {
            overlay.style.display = "none";
            beginGame();
          }
        };
        tick();
      }
    };

    if (cd.readyState < 1) {
      cd.addEventListener('loadedmetadata', begin, {once:true});
      setTimeout(()=>{ if (cd.readyState < 1) begin(); }, 400);
    } else {
      begin();
    }
  }

  /**********************
   * ã‚²ãƒ¼ãƒ æœ¬ä½“
   **********************/
  function beginGame(){
    // ã‚¹ã‚¿ãƒ¼ãƒˆç”»é¢ã‚’æ¶ˆã™ï¼ˆTOP10ã‚‚éè¡¨ç¤ºã®ã”è¦æœ›ï¼‰
    document.getElementById('startArea').style.display = "none";
    // ã‚²ãƒ¼ãƒ ç”»é¢ON
    document.getElementById('gameArea').style.display = "block";
    document.getElementById('homeBtnTop').style.display = "inline-block";

    shuffle(questions);
    current = 0; score = 0; penaltyTime = 0; wrongList = [];
    paused = false; totalPaused = 0;

    document.getElementById('totalQuestions').textContent = questions.length;
    document.getElementById('score').textContent = score;
    document.getElementById('accuracy').textContent = "0.0%";
    document.getElementById('result').textContent = "";

    startTime = Date.now();
    elapsedTimer = setInterval(updateElapsed, 50);

    showQuestion();
  }

  function updateElapsed(){
    const sec = (Date.now() - startTime - totalPaused + penaltyTime) / 1000;
    document.getElementById('elapsed').textContent = sec.toFixed(2);
  }

  function showQuestion(){
    if(current >= questions.length){ endGame(); return; }
    document.getElementById('question').textContent = questions[current].text;
    document.getElementById('questionNumber').textContent = current + 1;
    document.getElementById('result').textContent = "";
  }

  function updateAccuracy(){
    const answered = Math.max(current, 1);
    const rate = ((score / answered) * 100).toFixed(1);
    document.getElementById('accuracy').textContent = `${rate}%`;
  }

  function checkAnswer(choice){
    if(paused) return;
    const correct = questions[current].answer;
    if(choice === correct){
      score++;
      document.getElementById('result').textContent = "â­• æ­£è§£ï¼";
      playSE("correctSound");
    }else{
      document.getElementById('result').textContent = `âŒ ä¸æ­£è§£ï¼ˆæ­£è§£: ${labelMap[correct]}ï¼‰`;
      wrongList.push({ q: questions[current].text, your: labelMap[choice]||"ï¼ˆç„¡å›ç­”ï¼‰", right: labelMap[correct] });
      penaltyTime += 10000; // 10ç§’ãƒšãƒŠãƒ«ãƒ†ã‚£
      updateElapsed();
      playSE("wrongSound");
    }
    document.getElementById('score').textContent = score;
    current++;
    updateAccuracy();
    setTimeout(showQuestion, 900);
  }

  function togglePause(){
    if(!paused){
      paused = true;
      pauseStart = Date.now();
      clearInterval(elapsedTimer);
      document.getElementById("pauseBtn").textContent = "â–¶ å†é–‹";
      document.getElementById("result").textContent = "â¸ ä¸€æ™‚åœæ­¢ä¸­";
    }else{
      paused = false;
      totalPaused += Date.now() - pauseStart;
      elapsedTimer = setInterval(updateElapsed, 50);
      document.getElementById("pauseBtn").textContent = "â¸ ä¸€æ™‚åœæ­¢";
      document.getElementById("result").textContent = "";
    }
  }

  function quitGame(){
    if(confirm("ã‚²ãƒ¼ãƒ ã‚’çµ‚äº†ã—ã¾ã™ã‹ï¼Ÿ")){
      clearInterval(elapsedTimer);
      showFinalReport(true);
    }
  }

  function goHome(){
    // é€”ä¸­/çµ‚äº† ã„ãšã‚Œã§ã‚‚ãƒ›ãƒ¼ãƒ ã¸
    try{ clearInterval(elapsedTimer); }catch{}
    document.getElementById('gameArea').style.display = "none";
    document.getElementById('finalReport').style.display = "none";
    document.getElementById('startArea').style.display = "block";
    document.getElementById('homeBtnTop').style.display = "none";
    renderTop10(); // å¿µã®ãŸã‚å†æç”»
    window.scrollTo({ top:0, behavior:'smooth' });
  }

  /**********************
   * ã‚²ãƒ¼ãƒ çµ‚äº† â†’ Firestoreè¨˜éŒ² â†’ é †ä½è¨ˆç®—
   **********************/
  async function endGame(){
    clearInterval(elapsedTimer);
    showFinalReport(false);
  }

  async function showFinalReport(earlyQuit){
    const totalSec = Number(((Date.now() - startTime - totalPaused + penaltyTime)/1000).toFixed(2));
    const answeredAll = !earlyQuit && current >= questions.length;

    let docId = null, myRank = null, total = 0;

    // å®Œèµ°ã—ãŸå ´åˆã®ã¿è¨˜éŒ²ãƒ»é †ä½è¨ˆç®—ï¼ˆã”è¦æœ›ä»•æ§˜ï¼‰
    if(answeredAll){
      const docRef = await db.collection('scores').add({
        name: "",
        comment: "",
        correct: score,
        time: totalSec,
        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
        createdAtLocal: new Date().toISOString()
      });
      docId = docRef.id;

      const snap = await db.collection('scores')
        .orderBy('time','asc').orderBy('correct','desc').orderBy('createdAt','asc')
        .get();
      snap.forEach((d,i)=>{ total++; if(d.id===docId) myRank=i+1; });
    }

    // ãƒ¬ãƒãƒ¼ãƒˆè¡¨ç¤º
    const percent = ((score / questions.length) * 100).toFixed(1);
    let html = `<h3>çµæœç™ºè¡¨</h3>
      <p>æ­£è§£æ•°: <strong>${score}</strong> / ${questions.length}</p>
      <p>æ­£è§£ç‡: <strong>${percent}%</strong></p>
      <p>ã‹ã‹ã£ãŸæ™‚é–“: <strong>${totalSec.toFixed(2)}ç§’</strong></p>`;

    if(answeredAll){
      html += `<p>ã‚ãªãŸã®é †ä½ï¼ˆå®Œèµ°è€…ä¸­ï¼‰: <strong>${myRank}</strong> / å…¨<strong>${total}</strong></p>`;
    }else{
      html += `<p style="color:#d9534f;">é€”ä¸­ã§çµ‚äº†ã—ã¾ã—ãŸï¼ˆè¨˜éŒ²ãƒ»é †ä½ã¯è¨ˆæ¸¬ã—ã¾ã›ã‚“ï¼‰ã€‚</p>`;
    }

    if(wrongList.length){
      html += `<h4>é–“é•ã£ãŸå•é¡Œ</h4>`;
      wrongList.forEach(x=>{
        html += `<div class="report-item">
          <div><strong>å•é¡Œ:</strong> ${esc(x.q)}</div>
          <div class="wrong"><strong>ã‚ãªãŸã®ç­”ãˆ:</strong> ${esc(x.your)}</div>
          <div class="correct"><strong>æ­£è§£:</strong> ${esc(x.right)}</div>
        </div>`;
      });
    }else if(answeredAll){
      html += `<p class="correct">å…¨å•æ­£è§£ï¼ãŠã‚ã§ã¨ã†ã”ã–ã„ã¾ã™ï¼</p>`;
    }

    // TOP10ã«å…¥ã£ãŸäººã ã‘ï¼šåå‰ãƒ»ã‚³ãƒ¡ãƒ³ãƒˆï¼ˆ20æ–‡å­—ï¼‰ã‚’é€ä¿¡å¯ã€é€ä¿¡å¾Œã¯ãƒ­ãƒƒã‚¯
    if(answeredAll){
      if(myRank <= 10){
        html += `
          <hr>
          <h4>ãƒ©ãƒ³ã‚­ãƒ³ã‚°ç”¨ã®åå‰ãƒ»ã‚³ãƒ¡ãƒ³ãƒˆ</h4>
          <p>â€» ã‚³ãƒ¡ãƒ³ãƒˆã¯<strong>20æ–‡å­—ä»¥å†…</strong>ã§ã™</p>
          <div style="display:flex; gap:8px; flex-wrap:wrap; align-items:center;">
            <input id="nameInput" placeholder="åå‰ï¼ˆä»»æ„ï¼‰" style="padding:8px;border:1px solid #ccc;border-radius:8px;">
            <input id="commentInput" placeholder="ã‚³ãƒ¡ãƒ³ãƒˆï¼ˆ20æ–‡å­—ä»¥å†…ï¼‰" maxlength="20" style="flex:1;min-width:200px;padding:8px;border:1px solid #ccc;border-radius:8px;">
            <button class="btn btn-success" id="submitBtn">é€ä¿¡</button>
          </div>
          <div id="submitMsg" style="margin-top:8px;"></div>
          <div style="margin-top:10px;">
            <button class="btn btn-link" id="viewRankBtn" style="display:none;">ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã‚’ã¿ã‚‹</button>
          </div>
        `;
      }else{
        html += `
          <hr>
          <p style="color:#d9534f;">æ®‹å¿µï¼TOP10åœå¤–ã§ã—ãŸï¼ˆåå‰ãƒ»ã‚³ãƒ¡ãƒ³ãƒˆã¯ç™»éŒ²ã§ãã¾ã›ã‚“ï¼‰ã€‚</p>
          <div style="margin-top:10px;">
            <button class="btn btn-secondary" onclick="goHome()">ğŸ  ã‚¹ã‚¿ãƒ¼ãƒˆç”»é¢ã«æˆ»ã‚‹</button>
          </div>
        `;
      }
    }else{
      html += `
        <hr>
        <div style="margin-top:10px;">
          <button class="btn btn-secondary" onclick="goHome()">ğŸ  ã‚¹ã‚¿ãƒ¼ãƒˆç”»é¢ã«æˆ»ã‚‹</button>
        </div>
      `;
    }

    const report = document.getElementById('finalReport');
    report.innerHTML = html;
    report.style.display = "block";
    document.getElementById('gameArea').style.display = "none";
    document.getElementById('homeBtnTop').style.display = "inline-block";

    if(answeredAll && myRank <= 10){
      const btn = document.getElementById('submitBtn');
      const msg = document.getElementById('submitMsg');
      const viewBtn = document.getElementById('viewRankBtn');
      btn.onclick = async ()=>{
        btn.disabled = true;
        const name = document.getElementById('nameInput').value || "";
        const comment = (document.getElementById('commentInput').value || "").slice(0,20);
        try{
          await db.collection('scores').doc(docId).update({ name, comment });
          msg.textContent = "é€ä¿¡ã—ã¾ã—ãŸã€‚";
          // å…¥åŠ›æ¬„ãƒ­ãƒƒã‚¯ï¼†ãƒœã‚¿ãƒ³éè¡¨ç¤º
          document.getElementById('nameInput').disabled = true;
          document.getElementById('commentInput').disabled = true;
          btn.style.display = "none";
          // ã€Œãƒ©ãƒ³ã‚­ãƒ³ã‚°ã‚’ã¿ã‚‹ã€ãƒœã‚¿ãƒ³ã‚’è¡¨ç¤ºï¼ˆæŠ¼ã™ã¨ã‚¹ã‚¿ãƒ¼ãƒˆã¸æˆ»ã£ã¦TOP10å†æç”»ï¼‰
          viewBtn.style.display = "inline-block";
          viewBtn.onclick = async ()=>{
            goHome();
            await renderTop10();
            window.scrollTo({ top:0, behavior:'smooth' });
          };
        }catch(e){
          console.error(e);
          msg.textContent = "é€ä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸã€‚æ™‚é–“ã‚’ãŠã„ã¦ãŠè©¦ã—ãã ã•ã„ã€‚";
          btn.disabled = false;
        }
      };
    }
  }

  /**********************
   * åˆæœŸè¡¨ç¤º
   **********************/
  document.addEventListener('DOMContentLoaded', renderTop10);
  </script>
</body>
</html>
