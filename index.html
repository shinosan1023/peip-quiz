<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>P.E.I.P. 分類クイズ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <style>
    body { font-family: sans-serif; text-align: center; background:#f4f4f4; padding:30px; margin:0; }
    h1 { color:#444; }

    /* スタート前から見える音声トグル */
    .topbar { display:flex; gap:10px; justify-content:center; align-items:center; flex-wrap:wrap; margin-bottom:8px; }
    .sound-toggle { display:inline-flex; align-items:center; gap:8px; padding:6px 10px; border-radius:999px; background:#fff; border:1px solid #ddd; }
    .sound-toggle input { width:20px; height:20px; }
    #soundLabel { font-weight:600; }

    .question { font-size:24px; margin:20px 0; }
    .buttons { margin:20px; display:flex; gap:14px; flex-wrap:wrap; justify-content:center; }

    /* 丸ボタン（やや小さめ） */
    .btn-circle{
      width: 34vw; height: 34vw; max-width: 150px; max-height: 150px;
      min-width: 110px; min-height: 110px;
      border-radius: 50%;
      display:flex; align-items:center; justify-content:center;
      padding: 10px;
      text-align:center; line-height:1.25;
      white-space:normal; word-break:keep-all;
      box-shadow: 0 4px 10px rgba(0,0,0,0.08);
      transition: transform .06s ease-out, filter .1s ease;
      border:none; cursor:pointer; color:#fff;
    }
    .btn-circle:active{ transform: scale(0.98); filter: brightness(0.96); }
    .btn-content{ display:flex; flex-direction:column; gap:2px; align-items:center; width:100%; }
    .line1{ font-weight:800; font-size:1.15em; }
    .line2{ font-weight:700; font-size:.85em; opacity:.98; }
    .line3{ font-weight:700; font-size:.85em; opacity:.95; }

    .P  { background:#e74c3c; }
    .E  { background:#3498db; }
    .I  { background:#f1c40f; color:#333; }
    .Ph { background:#2ecc71; }

    #startButton { background:#ff69b4; color:#fff; font-size:20px; padding:15px 40px; border-radius:14px; border:none; cursor:pointer; }

    .info { font-size:18px; margin-top:10px; display:flex; gap:16px; align-items:center; justify-content:center; flex-wrap:wrap; }

    .elapsed-badge {
      display:inline-block; padding:6px 14px; border-radius:999px;
      background:#e3f7ff; border:2px solid #5bc0de; color:#0b6d85;
      font-weight:800; letter-spacing:0.5px;
    }
    #elapsed { font-size:34px; }
    #elapsed .decimal { font-size:20px; vertical-align:super; }

    .acc-badge {
      display:inline-block; padding:6px 14px; border-radius:999px;
      background:#fff6e0; border:2px solid #f0ad4e; color:#856404; font-weight:800;
    }

    .result { font-size:20px; margin-top:16px; min-height:1.6em; }

    .report { text-align:left; margin:20px auto; max-width:780px; }
    .report h3 { border-bottom:2px solid #ccc; padding-bottom:5px; }
    .report-item { margin-bottom:12px; }
    .wrong { color:#d9534f; }
    .correct { color:#2e7d32; }

    #controlButtons { margin-top:20px; display:flex; gap:20px; justify-content:center; flex-wrap:wrap; }
    #pauseButton { background:#ff9800; color:#fff; font-size:22px; padding:16px 32px; border-radius:14px; border:none; cursor:pointer; }
    #quitButton  { background:#dc3545; color:#fff; font-size:22px; padding:16px 32px; border-radius:14px; border:none; cursor:pointer; }

    #countOverlay{
      position:fixed; inset:0; display:none; align-items:center; justify-content:center;
      background:rgba(0,0,0,.65); color:#fff; z-index:9999;
      font-weight:900; text-shadow:0 4px 14px rgba(0,0,0,.6); user-select:none;
      font-size:120px;
    }
    #countText { display:block; }

    @keyframes popscale { 0%{transform:scale(.7)} 60%{transform:scale(1.15)} 100%{transform:scale(1)} }
    .pop { animation: popscale .35s ease-out; }
  </style>
</head>
<body>
  <h1>P.E.I.P. 分類クイズ</h1>

  <div class="topbar">
    <label class="sound-toggle" title="効果音 ON/OFF">
      <input type="checkbox" id="soundToggle" checked />
      <span id="soundLabel">音声: ON</span>
    </label>
  </div>

  <div class="info" id="gameInfo" style="display:none;">
    <span>スコア: <strong id="score">0</strong></span>
    <span>問題: <strong id="questionNumber">0</strong> / <strong id="totalQuestions">0</strong></span>
    <span class="elapsed-badge">経過時間: <span id="elapsed">0<span class="decimal">.00</span></span> 秒</span>
    <span class="acc-badge">正解率: <strong id="accuracy">0.0%</strong></span>
  </div>

  <div class="question" id="question" style="display:none;">問題を読み込み中...</div>

  <div class="buttons" id="answerButtons" style="display:none;">
    <button class="btn-circle P"  onclick="checkAnswer('P')">
      <span class="btn-content"><span class="line1">きもち</span><span class="line2">Personality</span><span class="line3">個人</span></span>
    </button>
    <button class="btn-circle E"  onclick="checkAnswer('E')">
      <span class="btn-content"><span class="line1">まわり</span><span class="line2">Environment</span><span class="line3">環境</span></span>
    </button>
    <button class="btn-circle I"  onclick="checkAnswer('I')">
      <span class="btn-content"><span class="line1">できること</span><span class="line2">Independence</span><span class="line3">自立</span></span>
    </button>
    <button class="btn-circle Ph" onclick="checkAnswer('Ph')">
      <span class="btn-content"><span class="line1">からだ＆病気</span><span class="line2">Physical</span><span class="line3">身体</span></span>
    </button>
  </div>

  <div class="result" id="result"></div>

  <div id="controlButtons" style="display:none;">
    <button id="pauseButton" onclick="togglePause()">⏸ 一時停止</button>
    <button id="quitButton"  onclick="quitGame()">⏹ やめる</button>
  </div>

  <button id="startButton" onclick="startCountdown()">スタート</button>

  <div id="finalReport" class="report" style="display:none;"></div>

  <audio id="correctSound"   src="se_correct.mp3"  preload="auto"></audio>
  <audio id="wrongSound"     src="se_wrong.mp3"    preload="auto"></audio>
  <audio id="countdownSound" src="countdown.mp3"   preload="auto"></audio>

  <div id="countOverlay"><span id="countText">3</span></div>

  <!-- Firebase（ランキング用） -->
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>

  <script>
    const labelMap = { P:"きもち", E:"まわり", I:"できること", Ph:"からだ＆病気" };

    // ★ あなたの firebaseConfig（貼り付け済み）
    const firebaseConfig = {
      apiKey: "AIzaSyARGroRdf4DmJN5nOHdiVy-a9UCA1ruDPw",
      authDomain: "peip-quiz.firebaseapp.com",
      projectId: "peip-quiz",
      storageBucket: "peip-quiz.firebasestorage.app",
      messagingSenderId: "523666051548",
      appId: "1:523666051548:web:2a84fc0f2163872b2eff19",
      measurementId: "G-6049XMQEBK"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // ===== Firestore: 送信＆取得 =====
    async function submitScoreToFirestore({name, comment, correct, elapsedSec}) {
      const now = new Date();
      const payload = {
        name: name || "名無し",
        comment: (comment || "").slice(0, 140),
        correct: Number(correct) || 0,
        time: Number(elapsedSec) || 0,
        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
        createdAtLocal: now.toISOString()
      };
      const docRef = await db.collection('scores').add(payload);
      return docRef.id;
    }

    async function fetchLeaderboardAndRank({myId}) {
      const snap = await db.collection('scores')
        .orderBy('correct','desc')
        .orderBy('time','asc')
        .orderBy('createdAt','asc')
        .limit(1000)
        .get();

      const list=[]; snap.forEach(d=>list.push({ id:d.id, ...d.data() }));
      let myRank=null; list.forEach((r,i)=>{ if(r.id===myId) myRank=i+1; });
      return { myRank, top:list.slice(0,10), total:list.length };
    }

    function escapeHtml(s){return String(s).replace(/[&<>"'`=\/]/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;','/':'&#x2F;','=':'&#x3D;','`':'&#x60;'}[c]))}
    function formatLocal(iso){try{const d=new Date(iso);const z=n=>String(n).padStart(2,'0');return `${d.getFullYear()}-${z(d.getMonth()+1)}-${z(d.getDate())} ${z(d.getHours())}:${z(d.getMinutes())}`}catch{return iso||""}}

    function buildSubmitFormHTML(correct, elapsedSec){
      return `
        <h4>ランキング投稿（50問すべて解いた方のみ）</h4>
        <p>お名前（任意）と一言コメント（任意）を入力すると、<strong>ランキング</strong>に掲載できます。</p>
        <div style="display:flex;gap:10px;flex-wrap:wrap;align-items:center;">
          <input id="rankName" placeholder="お名前（任意）" style="padding:8px;border:1px solid #ccc;border-radius:8px;"/>
          <input id="rankComment" placeholder="一言コメント（任意・140字まで）" style="flex:1;min-width:260px;padding:8px;border:1px solid #ccc;border-radius:8px;"/>
          <button id="rankSubmitBtn" style="padding:10px 14px;border:none;border-radius:8px;background:#28a745;color:#fff;cursor:pointer;">送信してランキングを見る</button>
        </div>
        <div id="rankMessage" style="margin-top:10px;"></div>
        <div id="leaderboard" style="margin-top:16px;"></div>`;
    }
    async function wireUpRankSubmit(correct, elapsedSec){
      const btn=document.getElementById('rankSubmitBtn'); if(!btn) return;
      btn.onclick=async()=>{
        btn.disabled=true;
        const name=document.getElementById('rankName')?.value||"";
        const comment=document.getElementById('rankComment')?.value||"";
        const msgEl=document.getElementById('rankMessage');
        try{
          const myId=await submitScoreToFirestore({name,comment,correct,elapsedSec});
          msgEl.textContent="送信完了。ランキングを集計中…";
          const {myRank,top,total}=await fetchLeaderboardAndRank({myId});
          const topHtml=`
            <h4>ランキング（上位10件）</h4>
            <table style="width:100%;max-width:780px;border-collapse:collapse;">
              <thead><tr style="background:#f9f9f9">
                <th style="text-align:right;padding:6px;">順位</th>
                <th style="padding:6px;">名前</th>
                <th style="text-align:right;padding:6px;">正解数</th>
                <th style="text-align:right;padding:6px;">タイム</th>
                <th style="padding:6px;">日時</th>
                <th style="padding:6px;">コメント</th>
              </tr></thead>
              <tbody>
                ${top.map((r,i)=>`
                  <tr>
                    <td style="text-align:right;padding:6px;">${i+1}</td>
                    <td style="padding:6px;">${escapeHtml(r.name||"名無し")}</td>
                    <td style="text-align:right;padding:6px;">${Number(r.correct)||0}</td>
                    <td style="text-align:right;padding:6px;">${Number(r.time).toFixed(2)}s</td>
                    <td style="padding:6px;">${formatLocal(r.createdAtLocal)}</td>
                    <td style="padding:6px;">${escapeHtml(r.comment||"")}</td>
                  </tr>`).join("")}
              </tbody>
            </table>
            <p style="margin-top:10px;">あなたの<strong>ランキング</strong>順位：<strong>${myRank ?? "（集計外）"}</strong> / 全${total}件</p>`;
          document.getElementById('leaderboard').innerHTML=topHtml;
          msgEl.textContent="掲載しました。";
        }catch(e){
          console.error(e);
          msgEl.textContent="送信に失敗しました。時間をおいて再度お試しください。";
        }finally{ btn.disabled=false; }
      };
    }

    // ===== 問題（50問） =====
    const questions=[{text:"孫に会いたいと思っているか？",answer:"P"},{text:"洗濯物にしわはあるか？",answer:"E"},{text:"トイレで立位をとることができるか？",answer:"I"},{text:"便秘はないか？",answer:"Ph"},{text:"朝食の飲み物にこだわりはあるか？",answer:"P"},{text:"居室の手すりにぐらつきはないか？",answer:"E"},{text:"一人で歯磨きはできるか？",answer:"I"},{text:"むせこみはないか？",answer:"Ph"},{text:"デイサービスを楽しみにしているか？",answer:"P"},{text:"冷蔵庫の中に消費期限が過ぎた食品はないか？",answer:"E"},{text:"歩行器を使えば自立歩行はできるか？",answer:"I"},{text:"足にむくみはないか？",answer:"Ph"},{text:"好きな音楽は何か？",answer:"P"},{text:"洗面所の床は濡れていないか？",answer:"E"},{text:"トイレのボタンを操作することはできるか？",answer:"I"},{text:"肌は乾燥していないか？",answer:"Ph"},{text:"外出できるようになりたいという希望はあるか？",answer:"P"},{text:"居室のベッドは介助用ベッドか？",answer:"E"},{text:"自分で着替えはできるか？",answer:"I"},{text:"食欲の有無",answer:"Ph"},{text:"昔していた仕事は何か？",answer:"P"},{text:"今使用している福祉用具は何か？",answer:"E"},{text:"自分で電話をかけることができるか？",answer:"I"},{text:"視力はどの程度か？",answer:"Ph"},{text:"食べたいものはあるか？",answer:"P"},{text:"自宅で10ミリ以上の段差があるのはどこか？",answer:"E"},{text:"自分でお茶を入れて飲むことはできるか？",answer:"I"},{text:"夜間の頻尿の有無",answer:"Ph"},{text:"習慣となっていることは何か？",answer:"P"},{text:"介護保険制度で利用しているサービスは何か？",answer:"E"},{text:"朝の体操で体を動かすことはできているか？",answer:"I"},{text:"ふらつきはないか？",answer:"I"},{text:"趣味（編み物）を再開したいという思いはあるか？",answer:"P"},{text:"居室の温度・室温は？",answer:"E"},{text:"自分で食事を準備することはできるか？",answer:"I"},{text:"腰痛など体の痛みはないか？",answer:"Ph"},{text:"調味料にこだわりはあるか？",answer:"P"},{text:"テレビのボリュームはいくつか？",answer:"E"},{text:"自分で薬は管理できているか？",answer:"I"},{text:"まぶたに目やにはついていないか？",answer:"Ph"},{text:"どのような環境で寝たい思っているか？",answer:"P"},{text:"ベッドサイドにコールボタンなどの有無",answer:"E"},{text:"肘なしの椅子でも座位をとることはできているか？",answer:"I"},{text:"巻き爪はないか？",answer:"Ph"},{text:"何をしている時が幸せを感じる時か？",answer:"P"},{text:"近所の人との交流はあるか？",answer:"E"},{text:"買い物リストを自分で書くことはできるか？",answer:"I"},{text:"夜間に不眠の有無",answer:"Ph"},{text:"食事の際にこだわりの食器や場所はあるか？",answer:"P"},{text:"居室の換気状況",answer:"E"}];

    function shuffle(a){for(let i=a.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[a[i],a[j]]=[a[j],a[i]]}}

    let current=0,score=0,wrongAnswers=[];
    let startTime=0,elapsedTimer=null;
    let paused=false,pauseStartTime=0,totalPausedTime=0;
    let penaltyTime=0;
    let soundEnabled=true;

    const soundToggle=document.getElementById('soundToggle');
    const soundLabel=document.getElementById('soundLabel');
    soundToggle.addEventListener('change',()=>{soundEnabled=soundToggle.checked; soundLabel.textContent=soundEnabled?'音声: ON':'音声: OFF';});

    // カウントダウン：実測マーカー
    const COUNTDOWN_MARKERS=[{time:0.00,label:"3"},{time:0.90,label:"2"},{time:1.80,label:"1"},{time:2.65,label:"スタート！"}];
    const HOLD_AFTER_START=1.80, EPS=0.015;

    function startCountdown(){
      const cd=document.getElementById("countdownSound");
      const overlay=document.getElementById("countOverlay");
      const text=document.getElementById("countText");

      document.getElementById("finalReport").style.display="none";
      document.getElementById("gameInfo").style.display="flex";
      document.getElementById("question").style.display="none";
      document.getElementById("answerButtons").style.display="none";
      document.getElementById("controlButtons").style.display="none";
      document.getElementById("result").textContent="";
      document.getElementById("startButton").disabled=true;

      overlay.style.display="flex";

      let idx=0;
      const lastMarker=COUNTDOWN_MARKERS[COUNTDOWN_MARKERS.length-1].time;
      const endTime=lastMarker+HOLD_AFTER_START+0.05;

      const showLabel=s=>{ if(text.textContent===s) return; text.textContent=s; text.classList.remove('pop'); void text.offsetWidth; text.classList.add('pop'); };

      const begin=()=>{
        const startTs=performance.now();
        if(soundEnabled){
          try{cd.currentTime=0; cd.play().catch(()=>{});}catch(e){}
          const tick=()=>{
            const elapsed=(performance.now()-startTs)/1000;
            const t=cd.currentTime||elapsed;
            while(idx<COUNTDOWN_MARKERS.length && t+EPS>=COUNTDOWN_MARKERS[idx].time){ showLabel(COUNTDOWN_MARKERS[idx].label); idx++; }
            if(elapsed<endTime){ requestAnimationFrame(tick); } else { overlay.style.display="none"; beginGame(); }
          };
          tick();
        }else{
          const tick=()=>{
            const t=(performance.now()-startTs)/1000;
            while(idx<COUNTDOWN_MARKERS.length && t+EPS>=COUNTDOWN_MARKERS[idx].time){ showLabel(COUNTDOWN_MARKERS[idx].label); idx++; }
            if(t<endTime){ requestAnimationFrame(tick); } else { overlay.style.display="none"; beginGame(); }
          };
          tick();
        }
      };

      if(cd.readyState<1){ cd.addEventListener('loadedmetadata',begin,{once:true}); setTimeout(()=>{ if(cd.readyState<1) begin(); },400); } else { begin(); }
    }

    function beginGame(){
      shuffle(questions);
      current=0; score=0; wrongAnswers=[];
      paused=false; pauseStartTime=0; totalPausedTime=0; penaltyTime=0;

      document.getElementById("totalQuestions").innerText=questions.length;
      document.getElementById("score").innerText=score;
      updateAccuracy(0);

      document.getElementById("startButton").style.display="none";
      document.getElementById("question").style.display="block";
      document.getElementById("answerButtons").style.display="flex";
      document.getElementById("controlButtons").style.display="flex";
      document.getElementById("result").textContent="";

      startTime=Date.now();
      elapsedTimer=setInterval(updateElapsedTime,50);

      showQuestion();
    }

    function updateElapsedTime(){
      const sec=(Date.now()-startTime-totalPausedTime+penaltyTime)/1000;
      const intPart=Math.floor(sec);
      const decimalPart=(sec-intPart).toFixed(2).substring(1);
      document.getElementById("elapsed").innerHTML=`${intPart}<span class="decimal">${decimalPart}</span>`;
    }

    function showQuestion(){
      document.getElementById("question").innerText=questions[current].text;
      document.getElementById("questionNumber").innerText=current+1;
      document.getElementById("result").innerText="";
    }

    function playOnce(id){ if(!soundEnabled) return; const el=document.getElementById(id); try{ el.currentTime=0; el.play(); }catch(e){} }

    function checkAnswer(choice){
      if(paused) return;
      const correct=questions[current].answer;

      if(choice===correct){ score++; document.getElementById("result").innerText="⭕ 正解！"; playOnce("correctSound"); }
      else{
        document.getElementById("result").innerText=`❌ 不正解。正解は「${labelMap[correct]}」です。`;
        playOnce("wrongSound");
        wrongAnswers.push({question:questions[current].text, selected:labelMap[choice]||"（無回答）", correct:labelMap[correct]});
        penaltyTime+=5000; updateElapsedTime();
      }

      document.getElementById("score").innerText=score;
      updateAccuracy(current+1);

      current++;
      if(current<questions.length){ setTimeout(showQuestion,2000); }
      else{ clearInterval(elapsedTimer); showFinalReport(); }
    }

    function updateAccuracy(answered){
      const totalAnswered=Math.max(answered??0,current);
      const rate=totalAnswered>0?((score/totalAnswered)*100).toFixed(1):"0.0";
      document.getElementById("accuracy").textContent=`${rate}%`;
    }

    function togglePause(){
      if(!paused){
        paused=true; pauseStartTime=Date.now(); clearInterval(elapsedTimer);
        document.getElementById("pauseButton").textContent="▶ 再開";
        document.getElementById("result").textContent="⏸ 一時停止中";
      }else{
        paused=false; totalPausedTime+=Date.now()-pauseStartTime;
        elapsedTimer=setInterval(updateElapsedTime,50);
        document.getElementById("pauseButton").textContent="⏸ 一時停止";
        document.getElementById("result").textContent="";
      }
    }

    function quitGame(){ if(confirm("ゲームを終了しますか？")){ clearInterval(elapsedTimer); showFinalReport(); } }

    function showFinalReport(){
      document.getElementById("gameInfo").style.display="none";
      document.getElementById("question").style.display="none";
      document.getElementById("answerButtons").style.display="none";
      document.getElementById("controlButtons").style.display="none";

      const totalTimeSec=Number(((Date.now()-startTime-totalPausedTime+penaltyTime)/1000).toFixed(2));
      const percent=((score/questions.length)*100).toFixed(1);

      let html=`<h3>結果発表</h3>
        <p>正解数: <strong>${score}</strong> / ${questions.length}</p>
        <p>正解率: <strong>${percent}%</strong></p>
        <p>かかった時間: <strong>${totalTimeSec.toFixed(2)}秒</strong></p>`;

      if(wrongAnswers.length){
        html+=`<h4>間違った問題一覧</h4>`;
        wrongAnswers.forEach(item=>{
          html+=`<div class="report-item">
            <div><strong>問題:</strong> ${item.question}</div>
            <div class="wrong"><strong>あなたの答え:</strong> ${item.selected}</div>
            <div class="correct"><strong>正解:</strong> ${item.correct}</div>
          </div>`;
        });
      }else{
        html+=`<p class="correct">全問正解！おめでとうございます！</p>`;
      }
      html+=`<button onclick="startCountdown()" style="background:#ff69b4;color:#fff;font-size:20px;padding:15px 40px;border-radius:14px;border:none;cursor:pointer;">もう一度プレイ</button>`;

      const report=document.getElementById("finalReport");
      report.innerHTML=html; report.style.display="block";

      const answeredAll=(current>=questions.length);
      if(answeredAll){ report.innerHTML+=buildSubmitFormHTML(score,totalTimeSec); wireUpRankSubmit(score,totalTimeSec); }
    }
  </script>
</body>
</html>
