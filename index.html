<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<title>P.E.I.P. 分類クイズ</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<style>
  :root{
    --pink:#ff69b4;
    --blue:#3498db;
    --green:#2ecc71;
    --red:#e74c3c;
    --yellow:#f1c40f;
  }
  body { font-family: sans-serif; background:#f4f4f4; margin:0; }
  header { display:flex; align-items:center; justify-content:center; gap:10px; background:#fff; color:#444; padding:14px 10px; position:sticky; top:0; z-index:10; }
  header h1 { margin:0; font-size:20px; }
  #homeBtn { margin-left:auto; display:none; background:#6c757d; color:#fff; border:none; padding:8px 12px; border-radius:8px; cursor:pointer; font-size:14px; }
  #credit { font-size:12px; color:#666; text-align:center; padding:8px 0; }

  /* スタート画面 */
  #startArea { padding:16px; }
  #top10Box { max-width:980px; margin: 10px auto; background:#fff; border-radius:10px; padding:14px; }
  #startButtons { text-align:center; margin:18px 0; }
  #startButton { background:var(--pink); color:#fff; border:none; padding:14px 36px; font-size:18px; border-radius:12px; cursor:pointer; }

  /* ゲーム情報バー */
  .info { display:flex; justify-content:center; align-items:center; gap:16px; flex-wrap:wrap; margin:10px; }
  .badge { display:inline-block; padding:4px 10px; border-radius:999px; font-weight:700; }
  .elapsed-badge { background:#e3f7ff; border:2px solid #5bc0de; color:#0b6d85; }
  .acc-badge { background:#fff6e0; border:2px solid #f0ad4e; color:#856404; }

  /* 問題と回答ボタン */
  .question { text-align:center; font-size:22px; margin:10px 12px; }
  .buttons { display:flex; flex-wrap:wrap; justify-content:center; gap:14px; margin:12px; }
  .btn-circle{
    width: 132px; height:132px; border-radius:50%;
    display:flex; align-items:center; justify-content:center;
    border:none; cursor:pointer; color:#fff; box-shadow:0 4px 12px rgba(0,0,0,.08);
  }
  .btn-circle .btn-content{ display:flex; flex-direction:column; align-items:center; line-height:1.2; }
  .line1{ font-size:1.1em; font-weight:800; }
  .line2,.line3{ font-size:.85em; font-weight:700; opacity:.95; }

  .P{ background:var(--red); }               /* きもち・赤 */
  .E{ background:var(--blue); }              /* まわり・青 */
  .I{ background:var(--yellow); color:#333;} /* できること・黄（濃文字） */
  .Ph{ background:var(--green); }            /* からだ・緑 */

  .result { text-align:center; font-size:18px; min-height:1.6em; margin:8px 0; }

  /* ランキング表 */
  table { width:100%; border-collapse:collapse; }
  th, td { padding:8px; border-bottom:1px solid #e9e9e9; }
  th { background:#fafafa; text-align:left; }
  .num { text-align:right; }
  .crown { width:28px; height:28px; vertical-align:middle; }

  /* 結果 */
  #finalReport { max-width:980px; margin:16px auto; background:#fff; border-radius:10px; padding:14px; display:none; }
  #finalReport h3{ margin-top:0; }
  .report-item { margin:8px 0; }
  .wrong { color:#d9534f; }
  .correct { color:#2e7d32; }

  /* 汎用ボタン */
  .btn { padding:10px 16px; border:none; border-radius:10px; cursor:pointer; }
  .btn-primary { background:#007bff; color:#fff; }
  .btn-success { background:#28a745; color:#fff; }
  .btn-secondary { background:#6c757d; color:#fff; }
  .btn-link { background:transparent; color:#007bff; text-decoration:underline; cursor:pointer; border:none; }
</style>
</head>
<body>
  <header>
    <h1>P.E.I.P. 分類クイズ</h1>
    <button id="homeBtn" onclick="goHome()">スタート画面に戻る</button>
  </header>

  <!-- スタート画面（TOP10を表示） -->
  <div id="startArea">
    <div style="text-align:center; margin:8px 0;">
      <h2 style="margin:6px 0;">ランキング TOP10（タイムが短い順）</h2>
      <small>※ 50問完走者の中から、タイム→正解数→日時で並べています</small>
    </div>
    <div id="top10Box">読み込み中...</div>
    <div id="startButtons">
      <button id="startButton">スタート</button>
    </div>
    <div id="credit">
      ※P.E.I.P.は聖隷クリストファー大学の篠﨑良勝氏が介護過程教育の質向上のために作成した教材で、著作権は篠﨑良勝氏にあります。P.E.I.P.フレームワークで分類する場合は、必ずP.E.I.P.を学習した上で行うようにしてください。
    </div>
  </div>

  <!-- ゲーム画面 -->
  <div id="gameArea" style="display:none;">
    <div class="info">
      <span>スコア: <strong id="score">0</strong></span>
      <span>問題: <strong id="questionNumber">0</strong> / <strong id="totalQuestions">0</strong></span>
      <span class="badge elapsed-badge">経過時間: <strong id="elapsed">0.00</strong> 秒</span>
      <span class="badge acc-badge">正解率: <strong id="accuracy">0.0%</strong></span>
    </div>

    <div class="question" id="question">問題を読み込み中...</div>

    <!-- 回答ボタン（丸・3行構成） -->
    <div class="buttons" id="answerButtons">
      <button class="btn-circle P" onclick="checkAnswer('P')">
        <span class="btn-content">
          <span class="line1">きもち</span>
          <span class="line2">Personality</span>
          <span class="line3">個人</span>
        </span>
      </button>
      <button class="btn-circle E" onclick="checkAnswer('E')">
        <span class="btn-content">
          <span class="line1">まわり</span>
          <span class="line2">Environment</span>
          <span class="line3">環境</span>
        </span>
      </button>
      <button class="btn-circle I" onclick="checkAnswer('I')">
        <span class="btn-content">
          <span class="line1">できること</span>
          <span class="line2">Independence</span>
          <span class="line3">自立</span>
        </span>
      </button>
      <button class="btn-circle Ph" onclick="checkAnswer('Ph')">
        <span class="btn-content">
          <span class="line1">からだ＆病気</span>
          <span class="line2">Physical</span>
          <span class="line3">身体</span>
        </span>
      </button>
    </div>

    <div class="result" id="result"></div>
  </div>

  <!-- 結果表示 -->
  <div id="finalReport"></div>

  <!-- Firebase（Firestore） -->
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>

  <script>
  /**********************
   * Firebase 設定（あなたの実プロジェクトでOK）
   **********************/
  const firebaseConfig = {
    apiKey: "AIzaSyARGroRdf4DmJN5nOHdiVy-a9UCA1ruDPw",
    authDomain: "peip-quiz.firebaseapp.com",
    projectId: "peip-quiz",
    storageBucket: "peip-quiz.appspot.com",
    messagingSenderId: "523666051548",
    appId: "1:523666051548:web:2a84fc0f2163872b2eff19",
    measurementId: "G-6049XMQEBK"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();

  /**********************
   * 表示フォーマット
   **********************/
  const labelMap = { P:"きもち", E:"まわり", I:"できること", Ph:"からだ＆病気" };

  // カラフルな「王冠」SVG（1=黄色,2=灰色,3=茶色）
  function crownSVG(fill){
    return `<svg class="crown" viewBox="0 0 64 64" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
      <path fill="${fill}" d="M6 50h52l-3-24-10 8-9-16-9 16-10-8z"/><rect x="10" y="50" width="44" height="6" fill="${fill}"/>
    </svg>`;
  }
  const crown = (rank)=>{
    if(rank===1) return crownSVG("gold");         // 黄色
    if(rank===2) return crownSVG("gray");         // 灰色
    if(rank===3) return crownSVG("saddlebrown");  // 茶色
    return rank;
  };
  const fmtTime = (sec)=> (Number(sec)||0).toFixed(2) + "s";
  const fmtDate = (iso)=>{
    try{
      const d=new Date(iso);
      const z=n=>String(n).padStart(2,'0');
      return `${d.getFullYear()}-${z(d.getMonth()+1)}-${z(d.getDate())} ${z(d.getHours())}:${z(d.getMinutes())}`;
    }catch{return "";}
  };
  const esc = (s)=>String(s||"").replace(/[&<>"'`=\/]/g,c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;','/':'&#x2F;','=':'&#x3D;','`':'&#x60;' }[c]));

  /**********************
   * ランキング（完走者・タイム昇順）
   * 並び順：time asc → correct desc → createdAt asc
   * ※ 初回は Firestore が「複合インデックスが必要」と出すことがあります。
   **********************/
  async function fetchTop10ByTime(){
    const snap = await db.collection('scores')
      .orderBy('time','asc')
      .orderBy('correct','desc')
      .orderBy('createdAt','asc')
      .limit(10)
      .get();
    const list=[];
    snap.forEach(d=>list.push({ id:d.id, ...d.data() }));
    return list;
  }

  async function renderTop10(){
    const box=document.getElementById('top10Box');
    box.textContent="読み込み中...";
    try{
      const rows=await fetchTop10ByTime();
      if(!rows.length){ box.textContent="まだ記録がありません"; return; }
      let html = `<table>
        <thead>
          <tr><th>順位</th><th>名前</th><th class="num">正解</th><th class="num">タイム</th><th>日時</th><th>コメント</th></tr>
        </thead><tbody>`;
      rows.forEach((r,i)=>{
        html += `<tr>
          <td>${crown(i+1)}</td>
          <td>${esc(r.name)||"名無し"}</td>
          <td class="num">${Number(r.correct)||0}</td>
          <td class="num">${fmtTime(r.time)}</td>
          <td>${fmtDate(r.createdAtLocal)}</td>
          <td>${esc(r.comment)||""}</td>
        </tr>`;
      });
      html += `</tbody></table>`;
      box.innerHTML = html;
    }catch(e){
      console.error(e);
      box.textContent="ランキング取得に失敗しました。";
    }
  }

  /**********************
   * 問題（50問）
   **********************/
  const questions = [
    { text: "孫に会いたいと思っているか？", answer: "P" },
    { text: "洗濯物にしわはあるか？", answer: "E" },
    { text: "トイレで立位をとることができるか？", answer: "I" },
    { text: "便秘はないか？", answer: "Ph" },
    { text: "朝食の飲み物にこだわりはあるか？", answer: "P" },
    { text: "居室の手すりにぐらつきはないか？", answer: "E" },
    { text: "一人で歯磨きはできるか？", answer: "I" },
    { text: "むせこみはないか？", answer: "Ph" },
    { text: "デイサービスを楽しみにしているか？", answer: "P" },
    { text: "冷蔵庫の中に消費期限が過ぎた食品はないか？", answer: "E" },
    { text: "歩行器を使えば自立歩行はできるか？", answer: "I" },
    { text: "足にむくみはないか？", answer: "Ph" },
    { text: "好きな音楽は何か？", answer: "P" },
    { text: "洗面所の床は濡れていないか？", answer: "E" },
    { text: "トイレのボタンを操作することはできるか？", answer: "I" },
    { text: "肌は乾燥していないか？", answer: "Ph" },
    { text: "外出できるようになりたいという希望はあるか？", answer: "P" },
    { text: "居室のベッドは介助用ベッドか？", answer: "E" },
    { text: "自分で着替えはできるか？", answer: "I" },
    { text: "食欲の有無", answer: "Ph" },
    { text: "昔していた仕事は何か？", answer: "P" },
    { text: "今使用している福祉用具は何か？", answer: "E" },
    { text: "自分で電話をかけることができるか？", answer: "I" },
    { text: "視力はどの程度か？", answer: "Ph" },
    { text: "食べたいものはあるか？", answer: "P" },
    { text: "自宅で10ミリ以上の段差があるのはどこか？", answer: "E" },
    { text: "自分でお茶を入れて飲むことはできるか？", answer: "I" },
    { text: "夜間の頻尿の有無", answer: "Ph" },
    { text: "習慣となっていることは何か？", answer: "P" },
    { text: "介護保険制度で利用しているサービスは何か？", answer: "E" },
    { text: "朝の体操で体を動かすことはできているか？", answer: "I" },
    { text: "ふらつきはないか？", answer: "I" }, /* 自立に変更済み */
    { text: "趣味（編み物）を再開したいという思いはあるか？", answer: "P" },
    { text: "居室の温度・室温は？", answer: "E" },
    { text: "自分で食事を準備することはできるか？", answer: "I" },
    { text: "腰痛など体の痛みはないか？", answer: "Ph" },
    { text: "調味料にこだわりはあるか？", answer: "P" },
    { text: "テレビのボリュームはいくつか？", answer: "E" },
    { text: "自分で薬は管理できているか？", answer: "I" },
    { text: "まぶたに目やにはついていないか？", answer: "Ph" },
    { text: "どのような環境で寝たい思っているか？", answer: "P" },
    { text: "ベッドサイドにコールボタンなどの有無", answer: "E" },
    { text: "肘なしの椅子でも座位をとることはできているか？", answer: "I" },
    { text: "巻き爪はないか？", answer: "Ph" },
    { text: "何をしている時が幸せを感じる時か？", answer: "P" },
    { text: "近所の人との交流はあるか？", answer: "E" },
    { text: "買い物リストを自分で書くことはできるか？", answer: "I" },
    { text: "夜間に不眠の有無", answer: "Ph" },
    { text: "食事の際にこだわりの食器や場所はあるか？", answer: "P" },
    { text: "居室の換気状況", answer: "E" }
  ];

  /**********************
   * ゲーム状態
   **********************/
  let current = 0;
  let score = 0;
  let startTime = 0;
  let elapsedTimer = null;
  let penaltyTime = 0; // 不正解ペナルティ（ms）
  let wrongList = [];

  function shuffle(a){ for(let i=a.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]]; } }

  function startGame(){
    // スタート画面 → 非表示
    document.getElementById('startArea').style.display = "none";
    // ゲーム画面・ホームボタン → 表示
    document.getElementById('gameArea').style.display = "block";
    document.getElementById('homeBtn').style.display = "inline-block";

    // 初期化
    shuffle(questions);
    current = 0; score = 0; penaltyTime = 0; wrongList = [];
    document.getElementById('totalQuestions').textContent = questions.length;
    document.getElementById('score').textContent = score;
    document.getElementById('accuracy').textContent = "0.0%";
    document.getElementById('result').textContent = "";

    startTime = Date.now();
    elapsedTimer = setInterval(updateElapsed, 50);

    showQuestion();
  }

  function updateElapsed(){
    const sec = (Date.now() - startTime + penaltyTime) / 1000;
    document.getElementById('elapsed').textContent = sec.toFixed(2);
  }

  function showQuestion(){
    if(current >= questions.length){
      endGame();
      return;
    }
    document.getElementById('question').textContent = questions[current].text;
    document.getElementById('questionNumber').textContent = current + 1;
    document.getElementById('result').textContent = "";
  }

  function updateAccuracy(){
    const answered = Math.max(current, 1); // 0除算回避
    const rate = ((score / answered) * 100).toFixed(1);
    document.getElementById('accuracy').textContent = `${rate}%`;
  }

  function checkAnswer(choice){
    const correct = questions[current].answer;
    if(choice === correct){
      score++;
      document.getElementById('result').textContent = "⭕ 正解！";
    }else{
      document.getElementById('result').textContent = `❌ 不正解（正解: ${labelMap[correct]}）`;
      wrongList.push({ q: questions[current].text, your: labelMap[choice]||"（無回答）", right: labelMap[correct] });
      penaltyTime += 10000; // 10秒ペナルティ
      updateElapsed();
    }
    document.getElementById('score').textContent = score;
    current++;
    updateAccuracy();
    setTimeout(showQuestion, 900);
  }

  /**********************
   * ゲーム終了 → Firestore記録 → 順位計算
   * 50問完走者は全員対象。TOP10に入った人だけ名前/コメント送信可能（20文字まで）
   **********************/
  async function endGame(){
    clearInterval(elapsedTimer);
    const totalSec = Number(((Date.now() - startTime + penaltyTime)/1000).toFixed(2));

    // 記録を保存（名前/コメントは後から上位10位のみ入力）
    const docRef = await db.collection('scores').add({
      name: "",
      comment: "",
      correct: score,
      time: totalSec,
      createdAt: firebase.firestore.FieldValue.serverTimestamp(),
      createdAtLocal: new Date().toISOString()
    });

    // 全体の順位（完走者中）：time asc → correct desc → createdAt asc
    const snap = await db.collection('scores')
      .orderBy('time','asc').orderBy('correct','desc').orderBy('createdAt','asc')
      .get();
    let myRank=null, total=0;
    snap.forEach((d,i)=>{ total++; if(d.id===docRef.id) myRank=i+1; });

    // レポート表示
    const percent = ((score / questions.length) * 100).toFixed(1);
    let html = `<h3>結果発表</h3>
      <p>正解数: <strong>${score}</strong> / ${questions.length}</p>
      <p>正解率: <strong>${percent}%</strong></p>
      <p>かかった時間: <strong>${totalSec.toFixed(2)}秒</strong></p>
      <p>あなたの順位（完走者中）: <strong>${myRank}</strong> / 全<strong>${total}</strong></p>`;

    if(wrongList.length){
      html += `<h4>間違った問題</h4>`;
      wrongList.forEach(x=>{
        html += `<div class="report-item">
          <div><strong>問題:</strong> ${esc(x.q)}</div>
          <div class="wrong"><strong>あなたの答え:</strong> ${esc(x.your)}</div>
          <div class="correct"><strong>正解:</strong> ${esc(x.right)}</div>
        </div>`;
      });
    }else{
      html += `<p class="correct">全問正解！おめでとうございます！</p>`;
    }

    // 上位10位に入っていれば、名前/コメント入力可（コメント20文字まで）
    if(myRank <= 10){
      html += `
        <hr>
        <h4>ランキング用の名前・コメント</h4>
        <p>※ コメントは<strong>20文字以内</strong>です</p>
        <div style="display:flex; gap:8px; flex-wrap:wrap; align-items:center;">
          <input id="nameInput" placeholder="名前（任意）" style="padding:8px;border:1px solid #ccc;border-radius:8px;">
          <input id="commentInput" placeholder="コメント（20文字以内）" maxlength="20" style="flex:1;min-width:200px;padding:8px;border:1px solid #ccc;border-radius:8px;">
          <button class="btn btn-success" id="submitBtn">送信</button>
        </div>
        <div id="submitMsg" style="margin-top:8px;"></div>
        <div style="margin-top:10px;">
          <button class="btn btn-link" id="viewRankBtn" style="display:none;">ランキングをみる</button>
        </div>
      `;
    }else{
      html += `
        <hr>
        <p style="color:#d9534f;">残念！TOP10圏外でした（名前・コメントは登録できません）。</p>
        <div style="margin-top:10px;">
          <button class="btn btn-secondary" onclick="goHome()">スタート画面に戻る</button>
        </div>
      `;
    }

    const report = document.getElementById('finalReport');
    report.innerHTML = html;
    report.style.display = "block";
    document.getElementById('gameArea').style.display = "none";
    // ヘッダーの戻るボタンは終わった後も表示のまま

    if(myRank <= 10){
      // 送信ボタンとランキングを見るボタンの挙動
      const btn = document.getElementById('submitBtn');
      const msg = document.getElementById('submitMsg');
      const viewBtn = document.getElementById('viewRankBtn');
      btn.onclick = async ()=>{
        btn.disabled = true;
        const name = document.getElementById('nameInput').value || "";
        const comment = (document.getElementById('commentInput').value || "").slice(0,20);
        try{
          await db.collection('scores').doc(docRef.id).update({ name, comment });
          msg.textContent = "送信しました。";
          // 入力欄ロック（編集不可）
          document.getElementById('nameInput').disabled = true;
          document.getElementById('commentInput').disabled = true;
          btn.style.display = "none";
          // ランキングを見るボタンを表示
          viewBtn.style.display = "inline-block";
          viewBtn.onclick = async ()=>{
            goHome();          // スタート画面へ
            await renderTop10(); // 再描画
            window.scrollTo({ top:0, behavior:'smooth' });
          };
        }catch(e){
          console.error(e);
          msg.textContent = "送信に失敗しました。時間をおいてお試しください。";
          btn.disabled = false;
        }
      };
    }
  }

  function goHome(){
    // ゲームエリア・結果を閉じて、スタート画面へ
    document.getElementById('finalReport').style.display = "none";
    document.getElementById('gameArea').style.display = "none";
    document.getElementById('startArea').style.display = "block";
    document.getElementById('homeBtn').style.display = "none"; // スタート画面では非表示
    // スタート画面のTOP10は自動読み込み済み。必要なら再取得:
    // renderTop10();
  }

  /**********************
   * 起動処理
   **********************/
  document.getElementById('startButton').addEventListener('click', startGame);
  document.addEventListener('DOMContentLoaded', renderTop10);
  </script>
</body>
</html>
