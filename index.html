<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>P.E.I.P. åˆ†é¡ã‚¯ã‚¤ã‚º</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <style>
    body { font-family: sans-serif; text-align: center; background:#f4f4f4; padding:30px; margin:0; }
    h1 { color:#444; }

    /* ä¸Šéƒ¨ï¼šéŸ³å£°ãƒˆã‚°ãƒ«ï¼‹ã‚¹ã‚¿ãƒ¼ãƒˆã«æˆ»ã‚‹ */
    .topbar { display:flex; gap:10px; justify-content:center; align-items:center; flex-wrap:wrap; margin-bottom:8px; }
    .sound-toggle { display:inline-flex; align-items:center; gap:8px; padding:6px 10px; border-radius:999px; background:#fff; border:1px solid #ddd; }
    .sound-toggle input { width:20px; height:20px; }
    #soundLabel { font-weight:600; }
    #backToStart { background:#6c757d; color:#fff; border:none; padding:8px 14px; border-radius:10px; cursor:pointer; }

    .question { font-size:24px; margin:20px 0; }
    .buttons { margin:20px; display:flex; gap:14px; flex-wrap:wrap; justify-content:center; }

    /* ä¸¸ãƒœã‚¿ãƒ³ï¼ˆã‚„ã‚„å°ã•ã‚ï¼‰ */
    .btn-circle{
      width: 34vw; height: 34vw; max-width: 150px; max-height: 150px;
      min-width: 110px; min-height: 110px;
      border-radius: 50%;
      display:flex; align-items:center; justify-content:center;
      padding: 10px;
      text-align:center; line-height:1.25;
      white-space:normal; word-break:keep-all;
      box-shadow: 0 4px 10px rgba(0,0,0,0.08);
      transition: transform .06s ease-out, filter .1s ease;
      border:none; cursor:pointer; color:#fff;
    }
    .btn-circle:active{ transform: scale(0.98); filter: brightness(0.96); }
    .btn-content{ display:flex; flex-direction:column; gap:2px; align-items:center; width:100%; }
    .line1{ font-weight:800; font-size:1.15em; }
    .line2{ font-weight:700; font-size:.85em; opacity:.98; }
    .line3{ font-weight:700; font-size:.85em; opacity:.95; }

    /* è‰²ï¼ˆP/E/I/Phï¼‰ */
    .P  { background:#e74c3c; }              /* ãã‚‚ã¡ãƒ»èµ¤ */
    .E  { background:#3498db; }              /* ã¾ã‚ã‚Šãƒ»é’ */
    .I  { background:#f1c40f; color:#333; }  /* ã§ãã‚‹ã“ã¨ãƒ»é»„ï¼ˆæ–‡å­—æ¿ƒï¼‰ */
    .Ph { background:#2ecc71; }              /* ã‹ã‚‰ã ãƒ»ç·‘ */

    /* ã‚¹ã‚¿ãƒ¼ãƒˆãƒœã‚¿ãƒ³ï¼ˆãƒ”ãƒ³ã‚¯ï¼‰ */
    #startButton { background:#ff69b4; color:#fff; font-size:20px; padding:15px 40px; border-radius:14px; border:none; cursor:pointer; }

    /* æƒ…å ±ãƒãƒ¼ */
    .info { font-size:18px; margin-top:10px; display:flex; gap:16px; align-items:center; justify-content:center; flex-wrap:wrap; }

    /* çµŒéæ™‚é–“ãƒãƒƒã‚¸ */
    .elapsed-badge {
      display:inline-block; padding:6px 14px; border-radius:999px;
      background:#e3f7ff; border:2px solid #5bc0de; color:#0b6d85;
      font-weight:800; letter-spacing:0.5px;
    }
    #elapsed { font-size:34px; }
    #elapsed .decimal { font-size:20px; vertical-align:super; }

    /* æ­£è§£ç‡ãƒãƒƒã‚¸ */
    .acc-badge {
      display:inline-block; padding:6px 14px; border-radius:999px;
      background:#fff6e0; border:2px solid #f0ad4e; color:#856404; font-weight:800;
    }

    .result { font-size:20px; margin-top:16px; min-height:1.6em; }

    /* ãƒ¬ãƒãƒ¼ãƒˆ */
    .report { text-align:left; margin:20px auto; max-width:880px; }
    .report h3 { border-bottom:2px solid #ccc; padding-bottom:5px; }
    .report-item { margin-bottom:12px; }
    .wrong { color:#d9534f; }
    .correct { color:#2e7d32; }

    /* æ“ä½œãƒœã‚¿ãƒ³ï¼ˆå¤§ãããƒ»ç›®ç«‹ã¤ï¼‰ */
    #controlButtons { margin-top:20px; display:flex; gap:20px; justify-content:center; flex-wrap:wrap; }
    #pauseButton { background:#ff9800; color:#fff; font-size:22px; padding:16px 32px; border-radius:14px; border:none; cursor:pointer; }
    #quitButton  { background:#dc3545; color:#fff; font-size:22px; padding:16px 32px; border-radius:14px; border:none; cursor:pointer; }

    /* ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³ãƒ»ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ï¼ˆãƒ•ã‚§ãƒ¼ãƒ‰ç„¡ã—ãƒ»æ‹¡å¤§ã®ã¿ï¼‰ */
    #countOverlay{
      position:fixed; inset:0; display:none; align-items:center; justify-content:center;
      background:rgba(0,0,0,.65); color:#fff; z-index:9999;
      font-weight:900; text-shadow:0 4px 14px rgba(0,0,0,.6); user-select:none;
      font-size:120px;
    }
    #countText { display:block; }
    @keyframes popscale { 0%{transform:scale(.7);} 60%{transform:scale(1.15);} 100%{transform:scale(1);} }
    .pop { animation: popscale .35s ease-out; }

    /* ã‚¹ã‚¿ãƒ¼ãƒˆç”»é¢ï¼šãƒ©ãƒ³ã‚­ãƒ³ã‚° */
    #startTop10 {
      max-width: 900px; margin: 20px auto; background:#fff; border:1px solid #eee; border-radius:12px; padding:16px;
      box-shadow:0 4px 12px rgba(0,0,0,.05);
    }
    #startTop10 h3 { margin:0 0 10px; }
    table.leader { width:100%; border-collapse:collapse; }
    table.leader th, table.leader td { padding:8px; border-bottom:1px solid #f0f0f0; text-align:left; }
    table.leader th { background:#fafafa; }
    .rank-cell { text-align:right; width:60px; }
    .time-cell, .correct-cell { text-align:right; width:120px; }
    .crown { font-size: 28px; }      /* å¤§ãã‚ */
    .crown.gold { color:#DAA520; }   /* é‡‘ */
    .crown.silver { color:#B0B0B0;}  /* éŠ€ */
    .crown.bronze { color:#8B4513;}  /* èŒ¶ */

    /* ã‚¹ã‚¿ãƒ¼ãƒˆç”»é¢ã®æ“ä½œ */
    #startControls { margin: 16px 0; display:flex; gap:12px; justify-content:center; flex-wrap:wrap; }
    #viewRankingBtn { background:#17a2b8; color:#fff; border:none; padding:10px 16px; border-radius:10px; cursor:pointer; }
    #startButton { margin-top:8px; }

    /* æŠ•ç¨¿ãƒ•ã‚©ãƒ¼ãƒ ï¼ˆTOP10å…¥ã£ãŸäººã ã‘ï¼‰ */
    .rank-form { margin-top:18px; padding:12px; background:#fff; border-radius:10px; border:1px solid #eee; }
    .rank-form input { padding:8px; border:1px solid #ccc; border-radius:8px; }
    .rank-form small { color:#666; }
    .muted { color:#666; }
  </style>
</head>
<body>
  <h1>P.E.I.P. åˆ†é¡ã‚¯ã‚¤ã‚º</h1>

  <div class="topbar">
    <label class="sound-toggle" title="åŠ¹æœéŸ³ ON/OFF">
      <input type="checkbox" id="soundToggle" checked />
      <span id="soundLabel">éŸ³å£°: ON</span>
    </label>
    <button id="backToStart" onclick="goStart()">âŸ² ã‚¹ã‚¿ãƒ¼ãƒˆç”»é¢ã«æˆ»ã‚‹</button>
  </div>

  <!-- ã‚¹ã‚¿ãƒ¼ãƒˆç”»é¢ã®ãƒ©ãƒ³ã‚­ãƒ³ã‚°TOP10ï¼ˆéå»å…¨ãƒ‡ãƒ¼ã‚¿ã€50å•å®Œèµ°è€…ã®ä¸­ã‹ã‚‰ã€Œã‚¿ã‚¤ãƒ çŸ­ã„é †ã€ï¼‰ -->
  <div id="startTop10" style="display:block;">
    <h3>ãƒ©ãƒ³ã‚­ãƒ³ã‚° TOP10ï¼ˆå…¨æœŸé–“ï½œ50å•å®Œèµ°è€…ï½œæ™‚é–“ãŒçŸ­ã„é †ï¼‰</h3>
    <div id="startTop10Table">èª­ã¿è¾¼ã¿ä¸­â€¦</div>
    <div id="startControls">
      <button id="viewRankingBtn" onclick="refreshStartTop10()">ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã‚’ã¿ã‚‹</button>
    </div>
  </div>

  <!-- æƒ…å ±ãƒãƒ¼ï¼ˆé–‹å§‹å¾Œã«è¡¨ç¤ºï¼‰ -->
  <div class="info" id="gameInfo" style="display:none;">
    <span>ã‚¹ã‚³ã‚¢: <strong id="score">0</strong></span>
    <span>å•é¡Œ: <strong id="questionNumber">0</strong> / <strong id="totalQuestions">0</strong></span>
    <span class="elapsed-badge">çµŒéæ™‚é–“: <span id="elapsed">0<span class="decimal">.00</span></span> ç§’</span>
    <span class="acc-badge">æ­£è§£ç‡: <strong id="accuracy">0.0%</strong></span>
  </div>

  <!-- å•é¡Œæ–‡ -->
  <div class="question" id="question" style="display:none;">å•é¡Œã‚’èª­ã¿è¾¼ã¿ä¸­...</div>

  <!-- å›ç­”ãƒœã‚¿ãƒ³ï¼ˆä¸¸å½¢ãƒ»3è¡Œæ§‹æˆï¼‰ -->
  <div class="buttons" id="answerButtons" style="display:none;">
    <button class="btn-circle P"  onclick="checkAnswer('P')">
      <span class="btn-content">
        <span class="line1">ãã‚‚ã¡</span>
        <span class="line2">Personality</span>
        <span class="line3">å€‹äºº</span>
      </span>
    </button>
    <button class="btn-circle E"  onclick="checkAnswer('E')">
      <span class="btn-content">
        <span class="line1">ã¾ã‚ã‚Š</span>
        <span class="line2">Environment</span>
        <span class="line3">ç’°å¢ƒ</span>
      </span>
    </button>
    <button class="btn-circle I"  onclick="checkAnswer('I')">
      <span class="btn-content">
        <span class="line1">ã§ãã‚‹ã“ã¨</span>
        <span class="line2">Independence</span>
        <span class="line3">è‡ªç«‹</span>
      </span>
    </button>
    <button class="btn-circle Ph" onclick="checkAnswer('Ph')">
      <span class="btn-content">
        <span class="line1">ã‹ã‚‰ã ï¼†ç—…æ°—</span>
        <span class="line2">Physical</span>
        <span class="line3">èº«ä½“</span>
      </span>
    </button>
  </div>

  <div class="result" id="result"></div>

  <!-- æ“ä½œãƒœã‚¿ãƒ³ï¼ˆåœæ­¢/å†é–‹ãƒ»çµ‚äº†ï¼‰ -->
  <div id="controlButtons" style="display:none;">
    <button id="pauseButton" onclick="togglePause()">â¸ ä¸€æ™‚åœæ­¢</button>
    <button id="quitButton"  onclick="quitGame()">â¹ ã‚„ã‚ã‚‹</button>
  </div>

  <!-- ã‚¹ã‚¿ãƒ¼ãƒˆ -->
  <button id="startButton" onclick="startCountdown()">ã‚¹ã‚¿ãƒ¼ãƒˆ</button>

  <!-- çµæœãƒ¬ãƒãƒ¼ãƒˆ -->
  <div id="finalReport" class="report" style="display:none;"></div>

  <!-- åŠ¹æœéŸ³ -->
  <audio id="correctSound"   src="se_correct.mp3"  preload="auto"></audio>
  <audio id="wrongSound"     src="se_wrong.mp3"    preload="auto"></audio>
  <audio id="countdownSound" src="countdown.mp3"   preload="auto"></audio>

  <!-- ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³è¡¨ç¤º -->
  <div id="countOverlay"><span id="countText">3</span></div>

  <!-- Firebaseï¼ˆãƒ©ãƒ³ã‚­ãƒ³ã‚°ç”¨ï¼‰ -->
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>

  <script>
    /* ==== ãƒ©ãƒ™ãƒ« ==== */
    const labelMap = { P:"ãã‚‚ã¡", E:"ã¾ã‚ã‚Š", I:"ã§ãã‚‹ã“ã¨", Ph:"ã‹ã‚‰ã ï¼†ç—…æ°—" };

    /* ==== Firebase åˆæœŸåŒ–ï¼ˆã‚ãªãŸã®å€¤ã‚’ã‚»ãƒƒãƒˆæ¸ˆã¿ï¼‰ ==== */
    const firebaseConfig = {
      apiKey: "AIzaSyARGroRdf4DmJN5nOHdiVy-a9UCA1ruDPw",
      authDomain: "peip-quiz.firebaseapp.com",
      projectId: "peip-quiz",
      storageBucket: "peip-quiz.appspot.com",
      messagingSenderId: "523666051548",
      appId: "1:523666051548:web:2a84fc0f2163872b2eff19",
      measurementId: "G-6049XMQEBK"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    /* ==== Firestore: TOP10ï¼ˆå…¨æœŸé–“ï½œ50å•å®Œèµ°è€…ï½œã‚¿ã‚¤ãƒ æ˜‡é †â†’æ­£è§£é™é †â†’æ—¥æ™‚æ˜‡é †ï¼‰ ==== */
    async function fetchTop10ByTime() {
      const snap = await db.collection('scores')
        .where('total', '==', 50)
        .orderBy('time', 'asc')
        .orderBy('correct', 'desc')
        .orderBy('createdAt', 'asc')
        .limit(10)
        .get();

      const list = [];
      snap.forEach(doc => list.push({ id: doc.id, ...doc.data() }));
      return list;
    }

    // ã‚¹ã‚¿ãƒ¼ãƒˆç”»é¢ã«TOP10ã‚’æç”»
    async function refreshStartTop10(){
      const host = document.getElementById('startTop10Table');
      host.textContent = "èª­ã¿è¾¼ã¿ä¸­â€¦";
      try{
        const top = await fetchTop10ByTime();
        if(!top.length){
          host.textContent = "ã¾ã è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“ã€‚æœ€åˆã®æŒ‘æˆ¦è€…ã«ãªã‚Šã¾ã—ã‚‡ã†ï¼";
          return;
        }
        host.innerHTML = buildTop10Table(top, {showCrown:true});
      }catch(e){
        console.error(e);
        host.innerHTML = 'èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚<br>åˆå›ã¯ã€Œè¤‡åˆã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ãŒå¿…è¦ã€ã¨è¡¨ç¤ºã•ã‚Œã‚‹ã“ã¨ãŒã‚ã‚Šã¾ã™ã€‚ãã®å ´åˆã¯ãƒªãƒ³ã‚¯ã‹ã‚‰ <strong>time(æ˜‡é †) â†’ correct(é™é †) â†’ createdAt(æ˜‡é †)</strong> ã§ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚';
      }
    }

    function buildTop10Table(rows, {showCrown=false}={}){
      const crown = (i)=>{
        if(!showCrown) return '';
        if(i===0) return '<span class="crown gold">ğŸ‘‘</span>';
        if(i===1) return '<span class="crown silver">ğŸ‘‘</span>';
        if(i===2) return '<span class="crown bronze">ğŸ‘‘</span>';
        return '';
      };
      return `
        <table class="leader">
          <thead>
            <tr>
              <th class="rank-cell">é †ä½</th>
              <th>åå‰</th>
              <th class="correct-cell">æ­£è§£æ•°</th>
              <th class="time-cell">ã‚¿ã‚¤ãƒ </th>
              <th>æ—¥æ™‚</th>
              <th>ã‚³ãƒ¡ãƒ³ãƒˆ</th>
            </tr>
          </thead>
          <tbody>
            ${rows.map((r,i)=>`
              <tr>
                <td class="rank-cell">${i+1} ${crown(i)}</td>
                <td>${escapeHtml(r.name||"åç„¡ã—")}</td>
                <td class="correct-cell">${Number(r.correct)||0}</td>
                <td class="time-cell">${Number(r.time).toFixed(2)}s</td>
                <td>${formatLocalNoSec(r.commentTimestamp || r.createdAtLocal)}</td>
                <td>${escapeHtml(r.comment||"")}</td>
              </tr>`).join("")}
          </tbody>
        </table>`;
    }

    // ã‚¨ã‚¹ã‚±ãƒ¼ãƒ— & æ—¥ä»˜æ•´å½¢ï¼ˆç§’ãªã—ï¼‰
    function escapeHtml(s){ return String(s||"").replace(/[&<>"'`=\/]/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;','/':'&#x2F;','=':'&#x3D;','`':'&#x60;'}[c])); }
    function formatLocalNoSec(iso){
      try {
        const d=new Date(iso);
        const z=n=>String(n).padStart(2,'0');
        return `${d.getFullYear()}-${z(d.getMonth()+1)}-${z(d.getDate())} ${z(d.getHours())}:${z(d.getMinutes())}`;
      } catch { return iso || ""; }
    }

    // ã‚¹ã‚¿ãƒ¼ãƒˆç”»é¢åˆæœŸåŒ–
    document.addEventListener('DOMContentLoaded', refreshStartTop10);

    /* ==== ã‚²ãƒ¼ãƒ æœ¬ä½“ ==== */

    const questions = [
      { text: "å­«ã«ä¼šã„ãŸã„ã¨æ€ã£ã¦ã„ã‚‹ã‹ï¼Ÿ", answer: "P" },
      { text: "æ´—æ¿¯ç‰©ã«ã—ã‚ã¯ã‚ã‚‹ã‹ï¼Ÿ", answer: "E" },
      { text: "ãƒˆã‚¤ãƒ¬ã§ç«‹ä½ã‚’ã¨ã‚‹ã“ã¨ãŒã§ãã‚‹ã‹ï¼Ÿ", answer: "I" },
      { text: "ä¾¿ç§˜ã¯ãªã„ã‹ï¼Ÿ", answer: "Ph" },
      { text: "æœé£Ÿã®é£²ã¿ç‰©ã«ã“ã ã‚ã‚Šã¯ã‚ã‚‹ã‹ï¼Ÿ", answer: "P" },
      { text: "å±…å®¤ã®æ‰‹ã™ã‚Šã«ãã‚‰ã¤ãã¯ãªã„ã‹ï¼Ÿ", answer: "E" },
      { text: "ä¸€äººã§æ­¯ç£¨ãã¯ã§ãã‚‹ã‹ï¼Ÿ", answer: "I" },
      { text: "ã‚€ã›ã“ã¿ã¯ãªã„ã‹ï¼Ÿ", answer: "Ph" },
      { text: "ãƒ‡ã‚¤ã‚µãƒ¼ãƒ“ã‚¹ã‚’æ¥½ã—ã¿ã«ã—ã¦ã„ã‚‹ã‹ï¼Ÿ", answer: "P" },
      { text: "å†·è”µåº«ã®ä¸­ã«æ¶ˆè²»æœŸé™ãŒéããŸé£Ÿå“ã¯ãªã„ã‹ï¼Ÿ", answer: "E" },
      { text: "æ­©è¡Œå™¨ã‚’ä½¿ãˆã°è‡ªç«‹æ­©è¡Œã¯ã§ãã‚‹ã‹ï¼Ÿ", answer: "I" },
      { text: "è¶³ã«ã‚€ãã¿ã¯ãªã„ã‹ï¼Ÿ", answer: "Ph" },
      { text: "å¥½ããªéŸ³æ¥½ã¯ä½•ã‹ï¼Ÿ", answer: "P" },
      { text: "æ´—é¢æ‰€ã®åºŠã¯æ¿¡ã‚Œã¦ã„ãªã„ã‹ï¼Ÿ", answer: "E" },
      { text: "ãƒˆã‚¤ãƒ¬ã®ãƒœã‚¿ãƒ³ã‚’æ“ä½œã™ã‚‹ã“ã¨ã¯ã§ãã‚‹ã‹ï¼Ÿ", answer: "I" },
      { text: "è‚Œã¯ä¹¾ç‡¥ã—ã¦ã„ãªã„ã‹ï¼Ÿ", answer: "Ph" },
      { text: "å¤–å‡ºã§ãã‚‹ã‚ˆã†ã«ãªã‚ŠãŸã„ã¨ã„ã†å¸Œæœ›ã¯ã‚ã‚‹ã‹ï¼Ÿ", answer: "P" },
      { text: "å±…å®¤ã®ãƒ™ãƒƒãƒ‰ã¯ä»‹åŠ©ç”¨ãƒ™ãƒƒãƒ‰ã‹ï¼Ÿ", answer: "E" },
      { text: "è‡ªåˆ†ã§ç€æ›¿ãˆã¯ã§ãã‚‹ã‹ï¼Ÿ", answer: "I" },
      { text: "é£Ÿæ¬²ã®æœ‰ç„¡", answer: "Ph" },
      { text: "æ˜”ã—ã¦ã„ãŸä»•äº‹ã¯ä½•ã‹ï¼Ÿ", answer: "P" },
      { text: "ä»Šä½¿ç”¨ã—ã¦ã„ã‚‹ç¦ç¥‰ç”¨å…·ã¯ä½•ã‹ï¼Ÿ", answer: "E" },
      { text: "è‡ªåˆ†ã§é›»è©±ã‚’ã‹ã‘ã‚‹ã“ã¨ãŒã§ãã‚‹ã‹ï¼Ÿ", answer: "I" },
      { text: "è¦–åŠ›ã¯ã©ã®ç¨‹åº¦ã‹ï¼Ÿ", answer: "Ph" },
      { text: "é£Ÿã¹ãŸã„ã‚‚ã®ã¯ã‚ã‚‹ã‹ï¼Ÿ", answer: "P" },
      { text: "è‡ªå®…ã§10ãƒŸãƒªä»¥ä¸Šã®æ®µå·®ãŒã‚ã‚‹ã®ã¯ã©ã“ã‹ï¼Ÿ", answer: "E" },
      { text: "è‡ªåˆ†ã§ãŠèŒ¶ã‚’å…¥ã‚Œã¦é£²ã‚€ã“ã¨ã¯ã§ãã‚‹ã‹ï¼Ÿ", answer: "I" },
      { text: "å¤œé–“ã®é »å°¿ã®æœ‰ç„¡", answer: "Ph" },
      { text: "ç¿’æ…£ã¨ãªã£ã¦ã„ã‚‹ã“ã¨ã¯ä½•ã‹ï¼Ÿ", answer: "P" },
      { text: "ä»‹è­·ä¿é™ºåˆ¶åº¦ã§åˆ©ç”¨ã—ã¦ã„ã‚‹ã‚µãƒ¼ãƒ“ã‚¹ã¯ä½•ã‹ï¼Ÿ", answer: "E" },
      { text: "æœã®ä½“æ“ã§ä½“ã‚’å‹•ã‹ã™ã“ã¨ã¯ã§ãã¦ã„ã‚‹ã‹ï¼Ÿ", answer: "I" },
      { text: "ãµã‚‰ã¤ãã¯ãªã„ã‹ï¼Ÿ", answer: "I" },  /* è‡ªç«‹ã«å¤‰æ›´ */
      { text: "è¶£å‘³ï¼ˆç·¨ã¿ç‰©ï¼‰ã‚’å†é–‹ã—ãŸã„ã¨ã„ã†æ€ã„ã¯ã‚ã‚‹ã‹ï¼Ÿ", answer: "P" },
      { text: "å±…å®¤ã®æ¸©åº¦ãƒ»å®¤æ¸©ã¯ï¼Ÿ", answer: "E" },
      { text: "è‡ªåˆ†ã§é£Ÿäº‹ã‚’æº–å‚™ã™ã‚‹ã“ã¨ã¯ã§ãã‚‹ã‹ï¼Ÿ", answer: "I" },
      { text: "è…°ç—›ãªã©ä½“ã®ç—›ã¿ã¯ãªã„ã‹ï¼Ÿ", answer: "Ph" },
      { text: "èª¿å‘³æ–™ã«ã“ã ã‚ã‚Šã¯ã‚ã‚‹ã‹ï¼Ÿ", answer: "P" },
      { text: "ãƒ†ãƒ¬ãƒ“ã®ãƒœãƒªãƒ¥ãƒ¼ãƒ ã¯ã„ãã¤ã‹ï¼Ÿ", answer: "E" },
      { text: "è‡ªåˆ†ã§è–¬ã¯ç®¡ç†ã§ãã¦ã„ã‚‹ã‹ï¼Ÿ", answer: "I" },
      { text: "ã¾ã¶ãŸã«ç›®ã‚„ã«ã¯ã¤ã„ã¦ã„ãªã„ã‹ï¼Ÿ", answer: "Ph" },
      { text: "ã©ã®ã‚ˆã†ãªç’°å¢ƒã§å¯ãŸã„æ€ã£ã¦ã„ã‚‹ã‹ï¼Ÿ", answer: "P" },
      { text: "ãƒ™ãƒƒãƒ‰ã‚µã‚¤ãƒ‰ã«ã‚³ãƒ¼ãƒ«ãƒœã‚¿ãƒ³ãªã©ã®æœ‰ç„¡", answer: "E" },
      { text: "è‚˜ãªã—ã®æ¤…å­ã§ã‚‚åº§ä½ã‚’ã¨ã‚‹ã“ã¨ã¯ã§ãã¦ã„ã‚‹ã‹ï¼Ÿ", answer: "I" },
      { text: "å·»ãçˆªã¯ãªã„ã‹ï¼Ÿ", answer: "Ph" },
      { text: "ä½•ã‚’ã—ã¦ã„ã‚‹æ™‚ãŒå¹¸ã›ã‚’æ„Ÿã˜ã‚‹æ™‚ã‹ï¼Ÿ", answer: "P" },
      { text: "è¿‘æ‰€ã®äººã¨ã®äº¤æµã¯ã‚ã‚‹ã‹ï¼Ÿ", answer: "E" },
      { text: "è²·ã„ç‰©ãƒªã‚¹ãƒˆã‚’è‡ªåˆ†ã§æ›¸ãã“ã¨ã¯ã§ãã‚‹ã‹ï¼Ÿ", answer: "I" },
      { text: "å¤œé–“ã«ä¸çœ ã®æœ‰ç„¡", answer: "Ph" },
      { text: "é£Ÿäº‹ã®éš›ã«ã“ã ã‚ã‚Šã®é£Ÿå™¨ã‚„å ´æ‰€ã¯ã‚ã‚‹ã‹ï¼Ÿ", answer: "P" },
      { text: "å±…å®¤ã®æ›æ°—çŠ¶æ³", answer: "E" }
    ];

    function shuffle(a){ for(let i=a.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]]; } }

    let current=0, score=0, wrongAnswers=[];
    let startTime=0, elapsedTimer=null;
    let paused=false, pauseStartTime=0, totalPausedTime=0;
    let penaltyTime = 0; // ä¸æ­£è§£ãƒšãƒŠãƒ«ãƒ†ã‚£ç´¯è¨ˆï¼ˆmsï¼‰
    let soundEnabled = true;

    // éŸ³å£°ON/OFF
    const soundToggle = document.getElementById('soundToggle');
    const soundLabel  = document.getElementById('soundLabel');
    soundToggle.addEventListener('change', ()=>{
      soundEnabled = soundToggle.checked;
      soundLabel.textContent = soundEnabled ? 'éŸ³å£°: ON' : 'éŸ³å£°: OFF';
    });

    // ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³ï¼šå®Ÿæ¸¬ãƒãƒ¼ã‚«ãƒ¼ï¼ˆã€Œã‚¹ã‚¿ãƒ¼ãƒˆï¼ã€1.8ç§’ä¿æŒï¼‰
    const COUNTDOWN_MARKERS = [
      { time: 0.00, label: "3" },
      { time: 0.90, label: "2" },
      { time: 1.80, label: "1" },
      { time: 2.65, label: "ã‚¹ã‚¿ãƒ¼ãƒˆï¼" }
    ];
    const HOLD_AFTER_START = 1.80;
    const EPS = 0.015;

    function startCountdown(){
      // ã‚¹ã‚¿ãƒ¼ãƒˆç”»é¢ã®TOP10ã¯æ¶ˆã™
      document.getElementById('startTop10').style.display = "none";

      const cd = document.getElementById("countdownSound");
      const overlay = document.getElementById("countOverlay");
      const text = document.getElementById("countText");

      // UI åˆæœŸåŒ–
      document.getElementById("finalReport").style.display = "none";
      document.getElementById("gameInfo").style.display = "flex";
      document.getElementById("question").style.display = "none";
      document.getElementById("answerButtons").style.display = "none";
      document.getElementById("controlButtons").style.display = "none";
      document.getElementById("result").textContent = "";
      document.getElementById("startButton").disabled = true;

      overlay.style.display = "flex";

      let idx = 0;
      const lastMarker = COUNTDOWN_MARKERS[COUNTDOWN_MARKERS.length-1].time;
      const endTime = lastMarker + HOLD_AFTER_START + 0.05;

      const showLabel = (s)=>{
        if (text.textContent === s) return;
        text.textContent = s;
        text.classList.remove('pop');
        void text.offsetWidth;
        text.classList.add('pop');
      };

      const begin = ()=>{
        const startTs = performance.now();

        if (soundEnabled) {
          try { cd.currentTime = 0; cd.play().catch(()=>{}); } catch(e){}

          const tick = ()=>{
            const elapsed = (performance.now() - startTs)/1000;
            const t = cd.currentTime || elapsed;
            while (idx < COUNTDOWN_MARKERS.length && t + EPS >= COUNTDOWN_MARKERS[idx].time) {
              showLabel(COUNTDOWN_MARKERS[idx].label);
              idx++;
            }
            if (elapsed < endTime) requestAnimationFrame(tick);
            else { overlay.style.display = "none"; beginGame(); }
          };
          tick();
        } else {
          const tick = ()=>{
            const t = (performance.now() - startTs)/1000;
            while (idx < COUNTDOWN_MARKERS.length && t + EPS >= COUNTDOWN_MARKERS[idx].time) {
              showLabel(COUNTDOWN_MARKERS[idx].label);
              idx++;
            }
            if (t < endTime) requestAnimationFrame(tick);
            else { overlay.style.display = "none"; beginGame(); }
          };
          tick();
        }
      };

      if (cd.readyState < 1) {
        cd.addEventListener('loadedmetadata', begin, {once:true});
        setTimeout(()=>{ if (cd.readyState < 1) begin(); }, 400);
      } else {
        begin();
      }
    }

    function beginGame(){
      shuffle(questions);
      current=0; score=0; wrongAnswers=[];
      paused=false; pauseStartTime=0; totalPausedTime=0; penaltyTime=0;

      document.getElementById("totalQuestions").innerText = questions.length;
      document.getElementById("score").innerText = score;
      updateAccuracy(0);

      document.getElementById("startButton").style.display = "none";
      document.getElementById("question").style.display = "block";
      document.getElementById("answerButtons").style.display = "flex";
      document.getElementById("controlButtons").style.display = "flex";
      document.getElementById("result").textContent = "";

      startTime = Date.now();
      elapsedTimer = setInterval(updateElapsedTime, 50);

      showQuestion();
    }

    function goStart(){
      // ã‚¹ã‚¿ãƒ¼ãƒˆç”»é¢ã«æˆ»ã‚‹
      clearInterval(elapsedTimer);
      document.getElementById("gameInfo").style.display = "none";
      document.getElementById("question").style.display = "none";
      document.getElementById("answerButtons").style.display = "none";
      document.getElementById("controlButtons").style.display = "none";
      document.getElementById("finalReport").style.display = "none";
      document.getElementById("startButton").style.display = "inline-block";
      document.getElementById("startButton").disabled = false;
      document.getElementById("startTop10").style.display = "block";
      refreshStartTop10();
      window.scrollTo({top:0, behavior:"smooth"});
    }

    function updateElapsedTime(){
      const sec = (Date.now() - startTime - totalPausedTime + penaltyTime) / 1000;
      const intPart = Math.floor(sec);
      const decimalPart = (sec - intPart).toFixed(2).substring(1);
      document.getElementById("elapsed").innerHTML =
        `${intPart}<span class="decimal">${decimalPart}</span>`;
    }

    function showQuestion(){
      document.getElementById("question").innerText = questions[current].text;
      document.getElementById("questionNumber").innerText = current + 1;
      document.getElementById("result").innerText = "";
    }

    function playOnce(id){
      if(!soundEnabled) return;
      const el = document.getElementById(id);
      try{ el.currentTime = 0; el.play(); }catch(e){}
    }

    function checkAnswer(choice){
      if(paused) return;
      const correct = questions[current].answer;

      if(choice === correct){
        score++;
        document.getElementById("result").innerText = "â­• æ­£è§£ï¼";
        playOnce("correctSound");
      }else{
        document.getElementById("result").innerText =
          `âŒ ä¸æ­£è§£ã€‚æ­£è§£ã¯ã€Œ${labelMap[correct]}ã€ã§ã™ã€‚`;
        playOnce("wrongSound");
        wrongAnswers.push({
          question: questions[current].text,
          selected: labelMap[choice] || "ï¼ˆç„¡å›ç­”ï¼‰",
          correct:  labelMap[correct]
        });
        penaltyTime += 10000; // â† 10ç§’ãƒšãƒŠãƒ«ãƒ†ã‚£
        updateElapsedTime();
      }

      document.getElementById("score").innerText = score;
      updateAccuracy(current + 1);

      current++;
      if(current < questions.length){
        setTimeout(showQuestion, 1200);
      }else{
        clearInterval(elapsedTimer);
        showFinalReport();
      }
    }

    function updateAccuracy(answered){
      const totalAnswered = Math.max(answered ?? 0, current);
      const rate = totalAnswered > 0 ? ((score/totalAnswered)*100).toFixed(1) : "0.0";
      document.getElementById("accuracy").textContent = `${rate}%`;
    }

    function togglePause(){
      if(!paused){
        paused = true;
        pauseStartTime = Date.now();
        clearInterval(elapsedTimer);
        document.getElementById("pauseButton").textContent = "â–¶ å†é–‹";
        document.getElementById("result").textContent = "â¸ ä¸€æ™‚åœæ­¢ä¸­";
      }else{
        paused = false;
        totalPausedTime += Date.now() - pauseStartTime;
        elapsedTimer = setInterval(updateElapsedTime, 50);
        document.getElementById("pauseButton").textContent = "â¸ ä¸€æ™‚åœæ­¢";
        document.getElementById("result").textContent = "";
      }
    }

    function quitGame(){
      if(confirm("ã‚²ãƒ¼ãƒ ã‚’çµ‚äº†ã—ã¾ã™ã‹ï¼Ÿ")){
        clearInterval(elapsedTimer);
        showFinalReport();
      }
    }

    // é€ä¿¡ï¼†ãƒ©ãƒ³ã‚­ãƒ³ã‚°å–å¾—ï¼ˆTOP10å…¥ã‚Šã®ã¿æŠ•ç¨¿å¯ï¼‰
    async function submitScoreToFirestore({name, comment, correct, elapsedSec}) {
      const now = new Date();
      const payload = {
        name: name || "åç„¡ã—",
        comment: (comment || "").slice(0, 20), // 20æ–‡å­—åˆ¶é™
        correct: Number(correct) || 0,
        total: 50,
        time: Number(elapsedSec) || 0,
        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
        createdAtLocal: now.toISOString(),
        commentTimestamp: formatLocalNoSec(now.toISOString()) // é€ä¿¡æ™‚ï¼ˆç§’ãªã—ï¼‰
      };
      const docRef = await db.collection('scores').add(payload);
      return docRef.id;
    }

    // å…¨å®Œèµ°è€…ã‹ã‚‰è‡ªåˆ†ã®é †ä½ï¼ˆã‚¿ã‚¤ãƒ æ˜‡é †â†’æ­£è§£é™é †â†’æ—¥æ™‚æ˜‡é †ï¼‰ã‚’æ±‚ã‚ã‚‹
    async function computeOverallRank(elapsedSec, correct){
      // ã–ã£ãã‚Šæœ€å¤§1000ä»¶ã§é †ä½ç®—å‡ºï¼ˆå¿…è¦ãªã‚‰ä¸Šé™ã¯å¾Œã§å¢—ã‚„ã›ã¾ã™ï¼‰
      const snap = await db.collection('scores')
        .where('total','==',50)
        .orderBy('time','asc')
        .orderBy('correct','desc')
        .orderBy('createdAt','asc')
        .limit(1000)
        .get();
      const list = [];
      snap.forEach(d=>list.push({id:d.id, ...d.data()}));
      // è‡ªåˆ†ã®é †ä½ = è‡ªåˆ†ã¨åŒç­‰ä»¥ä¸‹ã®ä½ç½®ã‚’äºŒåˆ†æ¢ç´¢ã§ã‚‚ã„ã„ãŒã€ã“ã“ã¯ç·šå½¢ã§OK
      const myIndex = list.findIndex(r =>
        Number(r.time).toFixed(2) == Number(elapsedSec).toFixed(2) &&
        Number(r.correct) == Number(correct)
      );
      return { rank: myIndex>=0 ? myIndex+1 : null, total: list.length, top10: list.slice(0,10) };
    }

    function buildTop10HTML(top){
      return buildTop10Table(top, {showCrown:true});
    }

    function buildSubmitFormHTML(correct, elapsedSec, enabled){
      const disabledAttr = enabled ? "" : "disabled";
      const msg = enabled
        ? `<small class="muted">ã‚³ãƒ¡ãƒ³ãƒˆã¯<strong>20æ–‡å­—ä»¥å†…</strong>ã€é€ä¿¡å¾Œã¯ç·¨é›†ã§ãã¾ã›ã‚“ã€‚</small>`
        : `<small class="muted">ä»Šå›ã¯TOP10ã«å…¥ã£ã¦ã„ãªã„ãŸã‚ã€æŠ•ç¨¿ã¯ã§ãã¾ã›ã‚“ã€‚</small>`;
      return `
        <div class="rank-form">
          <h4>ãƒ©ãƒ³ã‚­ãƒ³ã‚°æŠ•ç¨¿ï¼ˆTOP10å…¥ã‚Šã—ãŸå ´åˆã®ã¿å¯èƒ½ï¼‰</h4>
          ${msg}
          <div style="display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin-top:6px;">
            <input id="rankName" placeholder="ãŠåå‰ï¼ˆä»»æ„ï¼‰" ${disabledAttr}/>
            <input id="rankComment" placeholder="ä¸€è¨€ã‚³ãƒ¡ãƒ³ãƒˆï¼ˆ20æ–‡å­—ä»¥å†…ï¼‰" maxlength="20" ${disabledAttr} style="flex:1;min-width:260px;"/>
            <button id="rankSubmitBtn" ${disabledAttr}
              style="padding:10px 14px;border:none;border-radius:8px;background:#28a745;color:#fff;cursor:pointer;">
              é€ä¿¡
            </button>
          </div>
          <div id="rankMessage" style="margin-top:10px;"></div>
          <div id="leaderboard" style="margin-top:16px;"></div>
        </div>`;
    }

    function wireUpRankSubmit(correct, elapsedSec){
      const btn = document.getElementById('rankSubmitBtn'); if(!btn) return;
      btn.onclick = async ()=>{
        btn.disabled = true;
        const name = document.getElementById('rankName')?.value || "";
        const comment = document.getElementById('rankComment')?.value || "";
        const msgEl = document.getElementById('rankMessage');
        try{
          const myId = await submitScoreToFirestore({ name, comment, correct, elapsedSec });
          msgEl.textContent = "é€ä¿¡ã—ã¾ã—ãŸã€‚ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã‚’é›†è¨ˆä¸­â€¦";
          // é€ä¿¡å¾Œã«ã€Œãƒ©ãƒ³ã‚­ãƒ³ã‚°ã‚’è¦‹ã‚‹ã€ãƒœã‚¿ãƒ³ã‚’å‡ºã™
          const viewBtn = document.createElement('button');
          viewBtn.textContent = "ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã‚’ã¿ã‚‹";
          viewBtn.id = "afterViewRankingBtn";
          viewBtn.style = "margin-left:10px;padding:8px 12px;border:none;border-radius:8px;background:#17a2b8;color:#fff;cursor:pointer;";
          viewBtn.onclick = async ()=>{
            const { top10 } = await fetchAndBuildTop10(); // å†å–å¾—
            const board = document.getElementById('leaderboard');
            board.innerHTML = buildTop10HTML(top10);
          };
          msgEl.appendChild(document.createTextNode(" "));
          msgEl.appendChild(viewBtn);
        }catch(e){
          console.error(e);
          msgEl.textContent = "é€ä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸã€‚æ™‚é–“ã‚’ãŠã„ã¦å†åº¦ãŠè©¦ã—ãã ã•ã„ã€‚";
        }finally{
          btn.disabled = false;
          // å…¥åŠ›ã®ç·¨é›†ä¸å¯ã«
          document.getElementById('rankName').disabled = true;
          document.getElementById('rankComment').disabled = true;
        }
      };
    }

    async function fetchAndBuildTop10(){
      const top10 = await fetchTop10ByTime();
      return { top10, html: buildTop10HTML(top10) };
    }

    function showFinalReport(){
      document.getElementById("gameInfo").style.display = "none";
      document.getElementById("question").style.display = "none";
      document.getElementById("answerButtons").style.display = "none";
      document.getElementById("controlButtons").style.display = "none";

      const totalTimeSec = Number(((Date.now() - startTime - totalPausedTime + penaltyTime)/1000).toFixed(2));
      const percent = ((score / questions.length) * 100).toFixed(1);

      const container = document.getElementById("finalReport");
      container.style.display = "block";

      (async ()=>{
        // è‡ªåˆ†ã®ç·åˆé †ä½ã‚’å–å¾—ï¼ˆTOP10ã«å…¥ã‚‰ãªãã¦ã‚‚è¡¨ç¤ºï¼‰
        const { rank, total, top10 } = await computeOverallRank(totalTimeSec, score);
        const inTop10 = !!(top10.find((r,i)=> Number(r.time).toFixed(2)==totalTimeSec.toFixed(2) && Number(r.correct)==score ));

        let html = `<h3>çµæœç™ºè¡¨</h3>
          <p>æ­£è§£æ•°: <strong>${score}</strong> / ${questions.length}</p>
          <p>æ­£è§£ç‡: <strong>${percent}%</strong></p>
          <p>ã‹ã‹ã£ãŸæ™‚é–“: <strong>${totalTimeSec.toFixed(2)}ç§’</strong></p>`;

        if(wrongAnswers.length){
          html += `<h4>é–“é•ã£ãŸå•é¡Œä¸€è¦§</h4>`;
          wrongAnswers.forEach(item=>{
            html += `<div class="report-item">
              <div><strong>å•é¡Œ:</strong> ${item.question}</div>
              <div class="wrong"><strong>ã‚ãªãŸã®ç­”ãˆ:</strong> ${item.selected}</div>
              <div class="correct"><strong>æ­£è§£:</strong> ${item.correct}</div>
            </div>`;
          });
        }else{
          html += `<p class="correct">å…¨å•æ­£è§£ï¼ãŠã‚ã§ã¨ã†ã”ã–ã„ã¾ã™ï¼</p>`;
        }

        // ç·åˆé †ä½
        if(rank && total){
          html += `<p>ã‚ãªãŸã®ç·åˆé †ä½ï¼ˆå…¨æœŸé–“ãƒ»50å•å®Œèµ°è€…ä¸­ï¼‰: <strong>${rank}</strong> ä½ / å…¨ <strong>${total}</strong> ä»¶</p>`;
        } else {
          html += `<p>ã‚ãªãŸã®ç·åˆé †ä½ã¯é›†è¨ˆå¤–ã§ã™ï¼ˆãƒ‡ãƒ¼ã‚¿ä»¶æ•°ã®ç¯„å›²å¤–ï¼‰ã€‚</p>`;
        }

        // TOP10 è¡¨ï¼ˆå‚ç…§ç”¨ï¼‰
        html += `<h4>ç¾æ™‚ç‚¹ã®ãƒ©ãƒ³ã‚­ãƒ³ã‚° TOP10</h4>`;
        html += buildTop10HTML(top10);

        // æŠ•ç¨¿ãƒ•ã‚©ãƒ¼ãƒ ï¼ˆTOP10å…¥ã‚Šã®ã¿å¯èƒ½ï¼‰
        html += buildSubmitFormHTML(score, totalTimeSec, inTop10);

        // ã‚‚ã†ä¸€åº¦ãƒ—ãƒ¬ã‚¤ / ã‚¹ã‚¿ãƒ¼ãƒˆã«æˆ»ã‚‹
        html += `
          <div style="margin-top:12px; display:flex; gap:10px; flex-wrap:wrap;">
            <button onclick="startCountdown()" style="background:#ff69b4;color:#fff;font-size:16px;padding:10px 24px;border-radius:10px;border:none;cursor:pointer;">ã‚‚ã†ä¸€åº¦ãƒ—ãƒ¬ã‚¤</button>
            <button onclick="goStart()" style="background:#6c757d;color:#fff;font-size:16px;padding:10px 24px;border-radius:10px;border:none;cursor:pointer;">ã‚¹ã‚¿ãƒ¼ãƒˆç”»é¢ã«æˆ»ã‚‹</button>
          </div>`;

        container.innerHTML = html;

        // ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡ã®é…ç·šï¼ˆTOP10æ™‚ã®ã¿æœ‰åŠ¹ï¼‰
        if(inTop10) wireUpRankSubmit(score, totalTimeSec);
      })();
    }
  </script>
</body>
</html>
