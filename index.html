<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<title>P.E.I.P. åˆ†é¡ã‚¯ã‚¤ã‚º</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link rel="preload" as="image" href="./772063.jpg?v=1">
<style>
  :root{
    --text:#2f3a33;
    --card:#ffffffdd;
    --ring:#00b89433;
    --brand:#ff7f50;
  }
  body{
    font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans JP", sans-serif;
    margin:0; color:var(--text); overflow-x:hidden;
    background:#eaf6ed;
  }
  /* èƒŒæ™¯ç”»åƒï¼ˆåŒéšå±¤ã® 772063.jpgï¼‰ */
  body::before{
    content:"";
    position:fixed; inset:0; z-index:-2; pointer-events:none;
    background:url("./772063.jpg?v=1") center/cover no-repeat fixed;
    filter:saturate(1.05) brightness(.98);
  }
  body::after{
    content:"";
    position:fixed; inset:0; z-index:-1; pointer-events:none;
    background:linear-gradient(180deg, rgba(255,255,255,.65), rgba(255,255,255,.55) 40%, rgba(255,255,255,.45));
  }

  h1 { margin:0; padding:16px; text-align:center; background:#fff; color:var(--text);
       box-shadow:0 6px 20px rgba(0,0,0,.06); }

  .topbar { display:flex; gap:12px; justify-content:center; align-items:center; flex-wrap:wrap; padding:10px; background:transparent; }
  .sound-toggle { display:inline-flex; align-items:center; gap:8px; padding:6px 10px; border-radius:999px; background:var(--card); border:1px solid #eaeaea; box-shadow:0 6px 16px rgba(0,0,0,.05); }
  .homeBtn { padding:8px 12px; border:none; border-radius:8px; background:#6c757d; color:#fff; cursor:pointer; }
  .testBtn { padding:8px 12px; border:none; border-radius:8px; background:#28a745; color:#fff; cursor:pointer; }
  .right { display:flex; gap:8px; align-items:center; }

  #startArea { padding:16px; }
  #top10Box { max-width:960px; margin: 10px auto; background:var(--card); border-radius:10px; padding:14px; border:1px solid #f2f2f2; box-shadow:0 12px 28px rgba(0,0,0,.08); }
  #startButtons { text-align:center; margin:0 0 18px; }
  #startButton { background:#ff7f50; color:#fff; border:none; padding:14px 36px; font-size:18px; border-radius:12px; cursor:pointer; box-shadow:0 8px 18px rgba(255,127,80,.35); }

  #gameArea { max-width:980px; margin:0 auto; }
  .info { display:flex; justify-content:center; align-items:center; gap:16px; flex-wrap:wrap; margin:10px; }
  .badge { display:inline-block; padding:4px 10px; border-radius:999px; font-weight:700; }
  .elapsed-badge { background:#e9fff7; border:2px solid #24c9a5; color:#0b6d85; }
  .acc-badge { background:#fff9e8; border:2px solid #f6b14f; color:#7a5600; }

  .question { text-align:center; font-size:24px; font-weight:800; margin:12px; text-shadow:0 1px 0 rgba(255,255,255,.35); }

  .buttons { display:flex; flex-wrap:wrap; justify-content:center; gap:14px; margin:12px; }
  .btn-circle{
    width:132px; height:132px; border-radius:50%;
    display:flex; align-items:center; justify-content:center; cursor:pointer; color:#fff;
    border:3px solid #fff; 
    box-shadow:
      0 8px 18px rgba(0,0,0,.18),
      inset 0 2px 0 rgba(255,255,255,.45),
      inset 0 -2px 0 rgba(0,0,0,.06);
    transition:transform .06s ease, box-shadow .2s ease, filter .2s ease;
  }
  .btn-circle .btn-content{ display:flex; flex-direction:column; align-items:center; line-height:1.2; }
  .line1{ font-size:1.1em; font-weight:800; }
  .line2,.line3{ font-size:.85em; font-weight:700; opacity:.95; }
  .btn-circle:hover{ filter:brightness(1.05); box-shadow:
      0 10px 22px rgba(0,0,0,.22),
      inset 0 2px 0 rgba(255,255,255,.55),
      inset 0 -2px 0 rgba(0,0,0,.08);
  }
  .btn-circle:active{ transform:translateY(1px) scale(.985); }

  .P  { background:#e53935; }
  .E  { background:#1e88e5; }
  .I  { background:#ffca28; color:#2a2200; }
  .Ph { background:#43a047; }

  .result { text-align:center; font-size:18px; min-height:1.6em; margin:8px 0; }

  table { width:100%; border-collapse:collapse; }
  th, td { padding:8px; border-bottom:1px solid #e9e9e9; }
  th { background:#fafafa; text-align:left; }
  .num { text-align:right; }
  .crown { font-size:28px; line-height:1; }
  .rankLine { margin:8px 0 0; font-size:16px; color:#555; }
  .rankEm { font-size:32px; font-weight:900; color:#d9534f; }

  #controlButtons { margin-top:10px; display:flex; gap:10px; justify-content:center; flex-wrap:wrap; }
  .btn { padding:10px 16px; border:none; border-radius:10px; cursor:pointer; }
  .btn-primary { background:#007bff; color:#fff; }
  .btn-warning { background:#ff9800; color:#fff; }
  .btn-danger  { background:#dc3545; color:#fff; }
  .btn-secondary { background:#6c757d; color:#fff; }
  .btn-success { background:#28a745; color:#fff; }
  .btn-link { background:transparent; color:#007bff; text-decoration:underline; border:none; cursor:pointer; }

  #finalReport { max-width:960px; margin:16px auto; background:var(--card); border-radius:10px; padding:14px; display:none; border:1px solid #f2f2f2; box-shadow:0 12px 28px rgba(0,0,0,.08); }
  #finalReport h3{ margin:0 0 10px; }
  .report-item { margin:8px 0; }
  .wrong { color:#d9534f; }
  .correct { color:#2e7d32; }

  #countOverlay{ position:fixed; inset:0; display:none; align-items:center; justify-content:center; background:linear-gradient(180deg, rgba(0,0,0,.55), rgba(0,0,0,.45)); color:#fff; z-index:9999; font-weight:900; user-select:none; font-size:120px; }
  #countText { display:block; text-shadow:0 8px 30px rgba(0,0,0,.6); }
  @keyframes popscale { 0%{transform:scale(.7)} 60%{transform:scale(1.15)} 100%{transform:scale(1)} }
  .pop { animation: popscale .35s ease-out; }

  footer { margin:18px auto 28px; max-width:960px; font-size:12px; color:#555; padding:0 12px; }
  footer .note { background:var(--card); border:1px solid #eee; border-radius:8px; padding:10px; box-shadow:0 6px 16px rgba(0,0,0,.06); }

  button:focus-visible, input:focus-visible{ outline:2px solid var(--ring); outline-offset:2px; border-radius:10px; }

  @media (prefers-reduced-motion: reduce){
    .pop{ animation:none; }
    .btn-circle{ transition:none; }
  }
</style>
</head>
<body>
  <h1>P.E.I.P. åˆ†é¡ã‚¯ã‚¤ã‚º</h1>

  <div class="topbar">
    <label class="sound-toggle" title="åŠ¹æœéŸ³ ON/OFF">
      <input type="checkbox" id="soundToggle" checked />
      <span id="soundLabel">éŸ³å£°: ON</span>
    </label>
    <div class="right">
      <button class="testBtn" id="beepBtn" title="ã‚µã‚¦ãƒ³ãƒ‰è¨ºæ–­">ğŸ”Šãƒ†ã‚¹ãƒˆéŸ³</button>
      <button class="homeBtn" onclick="goHome()">ã‚¹ã‚¿ãƒ¼ãƒˆç”»é¢ã«æˆ»ã‚‹</button>
    </div>
  </div>

  <div id="startArea">
    <div id="startButtons">
      <button id="startButton" onclick="startCountdown()">ã‚¹ã‚¿ãƒ¼ãƒˆ</button>
    </div>
    <div style="text-align:center; margin:8px 0;">
      <h2 style="margin:6px 0;">ãƒ©ãƒ³ã‚­ãƒ³ã‚° TOP10ï¼ˆã‚¿ã‚¤ãƒ ãŒçŸ­ã„é †ï¼‰</h2>
      <small>â€» <b>å®Œèµ°è€…</b>ï¼ˆåŒã˜å•é¡Œæ•°ï¼‰ã®ä¸­ã‹ã‚‰ã€ã‚¿ã‚¤ãƒ  â†’ æ­£è§£æ•° â†’ æ—¥æ™‚ ã§ä¸¦ã¹ã¦ã„ã¾ã™</small>
    </div>
    <div id="top10Box">èª­ã¿è¾¼ã¿ä¸­...</div>
  </div>

  <div id="gameArea" style="display:none;">
    <div class="info">
      <span>ã‚¹ã‚³ã‚¢: <strong id="score">0</strong></span>
      <span>å•é¡Œ: <strong id="questionNumber">0</strong> / <strong id="totalQuestions">0</strong></span>
      <span class="badge elapsed-badge">çµŒéæ™‚é–“: <strong id="elapsed">0.00</strong> ç§’</span>
      <span class="badge acc-badge">æ­£è§£ç‡: <strong id="accuracy">0.0%</strong></span>
    </div>

    <div class="question" id="question">ã€Œå•é¡Œã‚’èª­ã¿è¾¼ã¿ä¸­...ã€</div>

    <div class="buttons" id="answerButtons">
      <button class="btn-circle P"  onclick="checkAnswer('P')"><span class="btn-content"><span class="line1">ãã‚‚ã¡</span><span class="line2">Personality</span><span class="line3">å€‹äºº</span></span></button>
      <button class="btn-circle E"  onclick="checkAnswer('E')"><span class="btn-content"><span class="line1">ã¾ã‚ã‚Š</span><span class="line2">Environment</span><span class="line3">ç’°å¢ƒ</span></span></button>
      <button class="btn-circle I"  onclick="checkAnswer('I')"><span class="btn-content"><span class="line1">ã§ãã‚‹ã“ã¨</span><span class="line2">Independence</span><span class="line3">è‡ªç«‹</span></span></button>
      <button class="btn-circle Ph" onclick="checkAnswer('Ph')"><span class="btn-content"><span class="line1">ã‹ã‚‰ã ï¼†ç—…æ°—</span><span class="line2">Physical</span><span class="line3">èº«ä½“</span></span></button>
    </div>

    <div class="result" id="result"></div>

    <div id="controlButtons">
      <button class="btn btn-warning" id="pauseButton" onclick="togglePause()">â¸ ä¸€æ™‚åœæ­¢</button>
      <button class="btn btn-danger"  id="quitButton"  onclick="quitGame()">â¹ ã‚„ã‚ã‚‹</button>
    </div>
  </div>

  <div id="finalReport"></div>

  <div id="countOverlay"><span id="countText">3</span></div>

  <!-- HTMLAudioï¼ˆiOSæ¶ˆéŸ³å„ªå…ˆã®ãŸã‚æ®‹ã™ï¼‰ -->
  <audio id="correctSound"   src="se_correct.mp3"  preload="auto" playsinline></audio>
  <audio id="wrongSound"     src="se_wrong.mp3"    preload="auto" playsinline></audio>
  <audio id="countdownSound" src="countdown.mp3"   preload="auto" playsinline></audio>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>

  <script>
  /* Firebase */
  const firebaseConfig = {
    apiKey: "AIzaSyARGroRdf4DmJN5nOHdiVy-a9UCA1ruDPw",
    authDomain: "peip-quiz.firebaseapp.com",
    projectId: "peip-quiz",
    storageBucket: "peip-quiz.appspot.com",
    messagingSenderId: "523666051548",
    appId: "1:523666051548:web:2a84fc0f2163872b2eff19",
    measurementId: "G-6049XMQEBK"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();

  /* Utils */
  const labelMap = { P:"ãã‚‚ã¡", E:"ã¾ã‚ã‚Š", I:"ã§ãã‚‹ã“ã¨", Ph:"ã‹ã‚‰ã ï¼†ç—…æ°—" };
  const crown = (i)=> i===1?'ğŸ¥‡':i===2?'ğŸ¥ˆ':i===3?'ğŸ¥‰':i;
  const fmtTime = (sec)=> (Number(sec)||0).toFixed(2) + "s";
  const fmtDate = (iso)=>{ try{ const d=new Date(iso); const z=n=>String(n).padStart(2,'0'); return `${d.getFullYear()}-${z(d.getMonth()+1)}-${z(d.getDate())} ${z(d.getHours())}:${z(d.getMinutes())}`; } catch{ return ""; } };
  const esc = (s)=>String(s||"").replace(/[&<>"'`=\/]/g,c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;','/':'&#x2F;','=':'&#x3D;','`':'&#x60;' }[c]));
  const shuffle = (a)=>{ for(let i=a.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]]; } };

  /* å•é¡Œ */
  const questions = [
    { text: "å­ã©ã‚‚ã«ä¼šã„ãŸã„ã¨æ€ã£ã¦ã„ã‚‹ã‹ï¼Ÿ", answer: "P" },{ text: "æ´—æ¿¯ç‰©ã«ã—ã‚ã¯ãªã„ã‹ï¼Ÿ", answer: "E" },
    { text: "ãƒˆã‚¤ãƒ¬ã§ç«‹ä½ã‚’ã¨ã‚‹ã“ã¨ãŒã§ãã‚‹ã‹ï¼Ÿ", answer: "I" },{ text: "ä¾¿ç§˜ã¯ãªã„ã‹ï¼Ÿ", answer: "Ph" },
    { text: "æœé£Ÿã®é£²ã¿ç‰©ã«ã“ã ã‚ã‚Šã¯ã‚ã‚‹ã‹ï¼Ÿ", answer: "P" },{ text: "ãƒˆã‚¤ãƒ¬ã®æ‰‹ã™ã‚Šã«ãã‚‰ã¤ãã¯ãªã„ã‹ï¼Ÿ", answer: "E" },
    { text: "æ­¯ç£¨ãã¯ä¸€äººã§è¡Œãˆã‚‹ã‹ï¼Ÿ", answer: "I" },{ text: "ã‚€ã›ã“ã¿ã¯ãªã„ã‹ï¼Ÿ", answer: "Ph" },
    { text: "ãƒ‡ã‚¤ã‚µãƒ¼ãƒ“ã‚¹ã‚’æ¥½ã—ã¿ã«ã—ã¦ã„ã‚‹ã‹ï¼Ÿ", answer: "P" },{ text: "å†·è”µåº«ã®ä¸­ã«æ¶ˆè²»æœŸé™ãŒéããŸé£Ÿå“ã¯ãªã„ã‹ï¼Ÿ", answer: "E" },
    { text: "æ­©è¡Œå™¨ã‚’ä½¿ãˆã°è‡ªç«‹æ­©è¡Œã¯ã§ãã‚‹ã‹ï¼Ÿ", answer: "I" },{ text: "è¶³ã«ã‚€ãã¿ã¯ãªã„ã‹ï¼Ÿ", answer: "Ph" },
    { text: "å¥½ããªéŸ³æ¥½ï¼ˆæ›²ãƒ»æ­Œæ‰‹ï¼‰ã¯ä½•ã‹ï¼Ÿ", answer: "P" },{ text: "æ´—é¢æ‰€ã®åºŠã¯æ¿¡ã‚Œã¦ã„ãªã„ã‹ï¼Ÿ", answer: "E" },
    { text: "ãƒˆã‚¤ãƒ¬ã®ãƒœã‚¿ãƒ³ã‚’æ“ä½œã™ã‚‹ã“ã¨ã¯ã§ãã‚‹ã‹ï¼Ÿ", answer: "I" },{ text: "è‚Œã¯ä¹¾ç‡¥ã—ã¦ã„ãªã„ã‹ï¼Ÿ", answer: "Ph" },
    { text: "æ–½è¨­ã®æš®ã‚‰ã—ã§å›°ã£ã¦ã„ã‚‹ã“ã¨ã¯ãªã„ã‹ï¼Ÿ", answer: "P" },{ text: "æ¯è‹¦ã—ã•ã‚„èƒ¸ã®åœ§è¿«æ„Ÿã¯ãªã„ã‹ï¼Ÿ", answer: "Ph" },
    { text: "ç€æ›¿ãˆã¯ä»‹åŠ©ãªã—ã§ãã‚‹ã‹ï¼Ÿ", answer: "I" },{ text: "é£Ÿæ¬²ã‚„æ°´åˆ†æ‘‚å–é‡ã¯ã©ã†ãªã£ã¦ã„ã‚‹ã‹ï¼Ÿ", answer: "Ph" },
    { text: "æ˜”ã—ã¦ã„ãŸä»•äº‹ã¯ä½•ã‹ï¼Ÿ", answer: "P" },{ text: "ä½¿ç”¨ã—ã¦ã„ã‚‹ç¦ç¥‰ç”¨å…·ã¯ä½•ã‹ï¼Ÿ", answer: "E" },
    { text: "é›»è©±ã‚’ã‹ã‘ã‚‹ã“ã¨ãŒã§ãã‚‹ã‹ï¼Ÿ", answer: "I" },{ text: "è¦–åŠ›ã¯ã©ã®ç¨‹åº¦ã‹ï¼Ÿ", answer: "Ph" },
    { text: "é£Ÿã¹ãŸã„ã‚‚ã®ã¯ã‚ã‚‹ã‹ï¼Ÿ", answer: "P" },{ text: "è‡ªå®…ã§10ãƒŸãƒªä»¥ä¸Šã®æ®µå·®ãŒã‚ã‚‹ã®ã¯ã©ã“ã‹ï¼Ÿ", answer: "E" },
    { text: "ãŠèŒ¶ã‚’å…¥ã‚Œã¦é£²ã‚€ã“ã¨ã¯ã§ãã‚‹ã‹ï¼Ÿ", answer: "I" },{ text: "å¤œé–“ã«é »å°¿ï¼ˆ2å›ä»¥ä¸Šï¼‰ã¯ãªã„ã‹ï¼Ÿ", answer: "Ph" },
    { text: "ç¿’æ…£ã¨ãªã£ã¦ã„ã‚‹ã“ã¨ã¯ä½•ã‹ï¼Ÿ", answer: "P" },{ text: "åˆ©ç”¨ã—ã¦ã„ã‚‹ä»‹è­·ä¿é™ºã®ã‚µãƒ¼ãƒ“ã‚¹ã¯ä½•ã‹ï¼Ÿ", answer: "E" },
    { text: "ä½“æ“ã§ä½“ã‚’å‹•ã‹ã™ã“ã¨ã¯ã§ãã¦ã„ã‚‹ã‹ï¼Ÿ", answer: "I" },{ text: "ãµã‚‰ã¤ãã¯ãªã„ã‹ï¼Ÿ", answer: "Ph" },
    { text: "è¶£å‘³ã®ã‚«ãƒ©ã‚ªã‚±ã‚’ã—ãŸã„ã¨ã„ã†æ€ã„ã¯ã‚ã‚‹ã‹ï¼Ÿ", answer: "P" },{ text: "å±…å®¤ã®æ¸©åº¦ãƒ»å®¤æ¸©ã¯ï¼Ÿ", answer: "E" },
    { text: "é£Ÿäº‹ã®æº–å‚™ã¯ä¸€äººã§ã§ãã‚‹ã‹ï¼Ÿ", answer: "I" },{ text: "è…°ç—›ãªã©ä½“ã®ç—›ã¿ã¯ãªã„ã‹ï¼Ÿ", answer: "Ph" },
    { text: "èª¿å‘³æ–™ã«ã“ã ã‚ã‚Šã¯ã‚ã‚‹ã‹ï¼Ÿ", answer: "P" },{ text: "è–¬ã®ç®¡ç†ã®éš›ã«æ‰‹ä¼ã£ã¦ã‚‚ã‚‰ã„ãŸã„ã“ã¨ã¯ã‚ã‚‹ã‹ï¼Ÿ", answer: "P" },
    { text: "è–¬ã®ç®¡ç†ã¯ä¸€äººã§è¡Œãˆã¦ã„ã‚‹ã‹ï¼Ÿ", answer: "I" },{ text: "ã¾ã¶ãŸã«ç›®ã‚„ã«ã¯ã¤ã„ã¦ã„ãªã„ã‹ï¼Ÿ", answer: "Ph" },
    { text: "ã©ã®ã‚ˆã†ãªç’°å¢ƒã§å¯ãŸã„æ€ã£ã¦ã„ã‚‹ã‹ï¼Ÿ", answer: "P" },{ text: "ã‚³ãƒ¼ãƒ«ãƒœã‚¿ãƒ³ã¯å±…å®¤ã®ã©ã“ã«ã‚ã‚‹ã‹ï¼Ÿ", answer: "E" },
    { text: "è‚˜ãªã—ã®æ¤…å­ã§ã‚‚åº§ä½ã‚’ã¨ã‚‹ã“ã¨ã¯ã§ãã‚‹ã‹ï¼Ÿ", answer: "I" },{ text: "å·»ãçˆªã¯ãªã„ã‹ï¼Ÿ", answer: "Ph" },
    { text: "ä½•ã‚’ã—ã¦ã„ã‚‹æ™‚ãŒå¹¸ã›ã‚’æ„Ÿã˜ã‚‹æ™‚ã‹ï¼Ÿ", answer: "P" },{ text: "ç¾åœ¨ã€äº¤æµã®ã‚ã‚‹äººã¯èª°ã‹ï¼Ÿ", answer: "E" },
    { text: "è²·ã„ç‰©ãƒªã‚¹ãƒˆã‚’è‡ªåˆ†ã§æ›¸ãã“ã¨ã¯ã§ãã‚‹ã‹ï¼Ÿ", answer: "I" },{ text: "å¤œé–“ã«ä¸çœ ã¯ãªã„ã‹ï¼Ÿ", answer: "Ph" },
    { text: "é£Ÿäº‹ã®éš›ã«ã“ã ã‚ã‚Šã®é£Ÿå™¨ã¯ã‚ã‚‹ã‹ï¼Ÿ", answer: "P" },{ text: "å±…å®¤ã®æ›æ°—çŠ¶æ³ã¯ï¼Ÿ", answer: "E" }
  ];
  const TOTAL_QUESTIONS = questions.length;

  /* çŠ¶æ…‹ */
  let current = 0, score = 0;
  let startTime = 0, elapsedTimer = null;
  let penaltyTime = 0, wrongList = [];
  let paused = false, pauseStartTime = 0, totalPausedTime = 0;

  /* ã‚µã‚¦ãƒ³ãƒ‰ï¼šiOSã¯HTMLAudioå„ªå…ˆï¼ˆæ¶ˆéŸ³ã‚¹ã‚¤ãƒƒãƒã«è¿½å¾“ï¼‰/ ãã®ä»–ã¯WebAudio */
  const isIOS = /iP(hone|ad|od)/i.test(navigator.userAgent) || 
                (navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 1); // iPadOSåˆ¤å®š
  const RESPECT_IOS_SILENT = true;

  let soundEnabled = true;
  const soundToggle = document.getElementById('soundToggle');
  const soundLabel  = document.getElementById('soundLabel');
  const AudioCtx = window.AudioContext || window.webkitAudioContext;
  let audioCtx = null, masterGain = null, audioUnlocked = false, useHtmlAudioFallback = isIOS && RESPECT_IOS_SILENT;
  const buffers = {};
  const urls = {
    correct:  document.getElementById('correctSound').src,
    wrong:    document.getElementById('wrongSound').src,
    cd:       document.getElementById('countdownSound').src
  };

  if (useHtmlAudioFallback) {
    // è¡¨ç¤ºã«æ³¨è¨˜
    soundLabel.textContent = 'éŸ³å£°: ONï¼ˆiOSã¯æ¶ˆéŸ³å„ªå…ˆï¼‰';
  }

  soundToggle.addEventListener('change', ()=>{
    soundEnabled = soundToggle.checked;
    soundLabel.textContent = soundEnabled
      ? (useHtmlAudioFallback ? 'éŸ³å£°: ONï¼ˆiOSã¯æ¶ˆéŸ³å„ªå…ˆï¼‰' : 'éŸ³å£°: ON')
      : 'éŸ³å£°: OFF';
    if(masterGain) masterGain.gain.value = soundEnabled ? 1 : 0;
    // HTMLAudio ã‚‚åŒæœŸ
    ['correctSound','wrongSound','countdownSound'].forEach(id=>{
      const el = document.getElementById(id);
      el.muted = !soundEnabled;
      if(!soundEnabled){ el.pause(); el.currentTime = 0; }
    });
  });

  async function loadBuffer(name, url){
    const res = await fetch(url, { cache: "force-cache" });
    if(!res.ok) throw new Error(`HTTP ${res.status}`);
    const buf = await res.arrayBuffer();
    buffers[name] = await new Promise((resolve, reject)=>{
      (audioCtx.decodeAudioData.length === 1)
        ? audioCtx.decodeAudioData(buf).then(resolve, reject)
        : audioCtx.decodeAudioData(buf, resolve, reject);
    });
  }

  async function unlockAndInitAudio(){
    if (useHtmlAudioFallback) return; // iOSã¯HTMLAudioã®ã¿
    try{
      if(!audioCtx) audioCtx = new AudioCtx();
      if(!masterGain){
        masterGain = audioCtx.createGain();
        masterGain.gain.value = soundEnabled ? 1 : 0;
        masterGain.connect(audioCtx.destination);
      }
      if(audioCtx.state !== 'running') await audioCtx.resume();
      const b = audioCtx.createBuffer(1, 1, audioCtx.sampleRate);
      const s = audioCtx.createBufferSource(); s.buffer = b; s.connect(masterGain); s.start();
      await Promise.all([ loadBuffer('correct', urls.correct), loadBuffer('wrong', urls.wrong), loadBuffer('cd', urls.cd) ]);
      audioUnlocked = true;
    }catch(e){
      console.warn("WebAudioåˆæœŸåŒ–å¤±æ•—ã€‚HTMLAudioã¸ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ã—ã¾ã™:", e);
      useHtmlAudioFallback = true;
      soundLabel.textContent = soundEnabled ? 'éŸ³å£°: ONï¼ˆiOSã¯æ¶ˆéŸ³å„ªå…ˆï¼‰' : 'éŸ³å£°: OFF';
    }
  }

  const onceOpts = { once:true, passive:true };
  window.addEventListener('pointerdown', unlockAndInitAudio, onceOpts);
  window.addEventListener('touchstart',  unlockAndInitAudio, onceOpts);
  window.addEventListener('click',       unlockAndInitAudio, onceOpts);
  window.addEventListener('keydown',     unlockAndInitAudio, onceOpts);

  function playBuffer(name){
    if(!soundEnabled) return;
    if(useHtmlAudioFallback || !audioUnlocked || !audioCtx || !buffers[name]){
      const id = name==='correct'?'correctSound': name==='wrong'?'wrongSound':'countdownSound';
      const el = document.getElementById(id);
      try{ el.pause(); el.currentTime = 0; el.play(); }catch(_){}
      return;
    }
    const src = audioCtx.createBufferSource();
    src.buffer = buffers[name];
    src.connect(masterGain);
    src.start(0);
  }

  function safePlay(id){
    if(id==='correctSound') return playBuffer('correct');
    if(id==='wrongSound')   return playBuffer('wrong');
    if(id==='countdownSound') return playBuffer('cd');
  }

  // ãƒ†ã‚¹ãƒˆéŸ³ï¼ˆWebAudio or HTMLAudioã§æ“¬ä¼¼ï¼‰
  document.getElementById('beepBtn').addEventListener('click', ()=>{
    if(!soundEnabled) return;
    if(useHtmlAudioFallback){
      const el = document.getElementById('correctSound');
      try{ el.pause(); el.currentTime = 0; el.play(); }catch(_){}
    }else{
      if(!audioCtx) audioCtx = new AudioCtx();
      if(!masterGain){ masterGain = audioCtx.createGain(); masterGain.gain.value = 1; masterGain.connect(audioCtx.destination); }
      if(audioCtx.state !== 'running'){ audioCtx.resume(); }
      const osc = audioCtx.createOscillator();
      const g = audioCtx.createGain(); g.gain.value = 0.12;
      osc.frequency.value = 880; osc.connect(g).connect(masterGain); osc.start(); setTimeout(()=>osc.stop(), 180);
    }
  });

  /* ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³ */
  const COUNTDOWN_MARKERS = [{time:0.00,label:"3"},{time:0.90,label:"2"},{time:1.80,label:"1"},{time:2.65,label:"ã‚¹ã‚¿ãƒ¼ãƒˆï¼"}];
  const HOLD_AFTER_START = 1.80, EPS = 0.015;

  function startCountdown(){
    document.getElementById("startButton").disabled = true;
    const cd = document.getElementById("countdownSound");
    const overlay = document.getElementById("countOverlay");
    const text = document.getElementById("countText");
    overlay.style.display = "flex";
    let idx = 0;
    const endTime = COUNTDOWN_MARKERS.at(-1).time + HOLD_AFTER_START + 0.05;

    const showLabel = (s)=>{ if(text.textContent!==s){ text.textContent=s; text.classList.remove('pop'); void text.offsetWidth; text.classList.add('pop'); } };

    const begin = ()=>{
      const t0 = performance.now();
      const tick = ()=>{
        const elapsed = (performance.now()-t0)/1000;
        const cur = cd.currentTime || elapsed;
        while(idx<COUNTDOWN_MARKERS.length && cur+EPS>=COUNTDOWN_MARKERS[idx].time){ showLabel(COUNTDOWN_MARKERS[idx].label); idx++; }
        if(elapsed<endTime){ requestAnimationFrame(tick); }else{ overlay.style.display="none"; beginGame(); }
      };
      safePlay('countdownSound');
      tick();
    };
    if (cd.readyState < 1) { cd.addEventListener('loadedmetadata', begin, {once:true}); setTimeout(()=>{ if(cd.readyState<1) begin(); }, 400); }
    else begin();
  }

  /* ã‚²ãƒ¼ãƒ æœ¬ä½“ */
  function beginGame(){
    document.getElementById('startArea').style.display = "none";
    document.getElementById('gameArea').style.display = "block";
    document.getElementById('finalReport').style.display = "none";

    shuffle(questions);
    current = 0; score = 0; penaltyTime = 0; wrongList = [];
    paused = false; pauseStartTime = 0; totalPausedTime = 0;

    document.getElementById('totalQuestions').textContent = TOTAL_QUESTIONS;
    document.getElementById('score').textContent = score;
    document.getElementById('accuracy').textContent = "0.0%";
    document.getElementById('result').textContent = "";

    startTime = Date.now();
    elapsedTimer = setInterval(updateElapsed, 50);
    showQuestion();
  }

  function updateElapsed(){
    const sec = (Date.now() - startTime - totalPausedTime + penaltyTime) / 1000;
    document.getElementById('elapsed').textContent = sec.toFixed(2);
  }

  function showQuestion(){
    if(current >= TOTAL_QUESTIONS){ endGame(); return; }
    const t = questions[current].text;
    document.getElementById('question').textContent = `ã€Œ${t}ã€`;
    document.getElementById('questionNumber').textContent = current + 1;
    document.getElementById('result').textContent = "";
  }

  function updateAccuracy(){
    const answered = Math.max(current, 1);
    const rate = ((score / answered) * 100).toFixed(1);
    document.getElementById('accuracy').textContent = `${rate}%`;
  }

  // é€£æ‰“é˜²æ­¢
  let answering = false;
  function checkAnswer(choice){
    if(paused || answering) return;
    answering = true;

    const correct = questions[current].answer;
    if(choice === correct){
      score++;
      document.getElementById('result').textContent = "â­• æ­£è§£ï¼";
      safePlay("correctSound");
    }else{
      document.getElementById('result').textContent = `âŒ ä¸æ­£è§£ï¼ˆæ­£è§£: ${labelMap[correct]}ï¼‰`;
      safePlay("wrongSound");
      wrongList.push({ q: questions[current].text, your: labelMap[choice]||"ï¼ˆç„¡å›ç­”ï¼‰", right: labelMap[correct] });
      penaltyTime += 10000; updateElapsed();
    }
    document.getElementById('score').textContent = score;
    current++; updateAccuracy();
    setTimeout(()=>{ showQuestion(); answering = false; }, 900);
  }

  function togglePause(){
    if(!paused){
      paused = true; pauseStartTime = Date.now(); clearInterval(elapsedTimer);
      document.getElementById('pauseButton').textContent = "â–¶ å†é–‹";
      document.getElementById('result').textContent = "â¸ ä¸€æ™‚åœæ­¢ä¸­";
    }else{
      paused = false; totalPausedTime += Date.now() - pauseStartTime; elapsedTimer = setInterval(updateElapsed, 50);
      document.getElementById('pauseButton').textContent = "â¸ ä¸€æ™‚åœæ­¢"; document.getElementById('result').textContent = "";
    }
  }

  function quitGame(){
    if(confirm("ã‚²ãƒ¼ãƒ ã‚’çµ‚äº†ã—ã¾ã™ã‹ï¼Ÿ")){
      clearInterval(elapsedTimer);
      showFinalReport(false);
    }
  }

  /* ãƒ©ãƒ³ã‚­ãƒ³ã‚° */
  async function fetchFinishers(){
    const snap = await db.collection('scores')
      .where('completed','==', true)
      .where('totalQuestions','==', TOTAL_QUESTIONS)
      .get();
    const list=[]; snap.forEach(d=>list.push({ id:d.id, ...d.data() }));
    list.sort((a,b)=>{
      if((a.time||0)!==(b.time||0)) return (a.time||0)-(b.time||0);
      if((a.correct||0)!==(b.correct||0)) return (b.correct||0)-(a.correct||0);
      return String(a.createdAtLocal||'').localeCompare(String(b.createdAtLocal||''));
    });
    return list;
  }

  async function renderTop10(){
    const box=document.getElementById('top10Box');
    box.textContent="èª­ã¿è¾¼ã¿ä¸­...";
    try{
      const rows = await fetchFinishers();
      if(!rows.length){ box.textContent="ã¾ã è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“"; return; }
      let html = `<table><thead><tr>
        <th>é †ä½</th><th>åå‰</th><th class="num">æ­£è§£</th><th class="num">ã‚¿ã‚¤ãƒ </th><th>æ—¥æ™‚</th><th>ã‚³ãƒ¡ãƒ³ãƒˆ</th>
      </tr></thead><tbody>`;
      rows.slice(0,10).forEach((r,i)=>{
        html += `<tr>
          <td class="crown">${crown(i+1)}</td>
          <td>${esc(r.name)||"åç„¡ã—"}</td>
          <td class="num">${Number(r.correct)||0}</td>
          <td class="num">${fmtTime(r.time)}</td>
          <td>${fmtDate(r.createdAtLocal)}</td>
          <td>${esc(r.comment)||""}</td>
        </tr>`;
      });
      html += `</tbody></table>`;
      box.innerHTML = html;
    }catch(e){
      console.error("TOP10ã®å–å¾—ã‚¨ãƒ©ãƒ¼:", e);
      box.textContent="ãƒ©ãƒ³ã‚­ãƒ³ã‚°å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚";
    }
  }

  /* çµ‚äº†â†’è¨˜éŒ² */
  function endGame(){ clearInterval(elapsedTimer); showFinalReport(true); }

  async function showFinalReport(finished){
    document.getElementById('gameArea').style.display = "none";
    const totalTimeSec = Number(((Date.now() - startTime - totalPausedTime + penaltyTime)/1000).toFixed(2));
    const answered = finished ? TOTAL_QUESTIONS : current;
    const percent  = ((score / (answered||1)) * 100).toFixed(1);

    let myDocId = null;
    const createdAtLocal = new Date().toISOString();
    try{
      const docRef = await db.collection('scores').add({
        name:"", comment:"", correct: score, time: totalTimeSec, totalQuestions: TOTAL_QUESTIONS,
        answered, completed: !!finished, createdAt: firebase.firestore.FieldValue.serverTimestamp(), createdAtLocal
      });
      myDocId = docRef.id;
    }catch(e){ console.error(e); }

    let myRank = null, finishers = 0;
    try{
      const rows = await fetchFinishers();
      finishers = rows.length;
      myRank = rows.findIndex(r=>r.id===myDocId);
      if(myRank>=0) myRank = myRank + 1;
    }catch(e){ console.error(e); }

    const canEditProfile = finished && myRank && myRank <= 10;

    let html = `
      <div style="display:flex; gap:8px; align-items:center; justify-content:space-between; flex-wrap:wrap;">
        <h3 style="margin:0;">çµæœç™ºè¡¨</h3>
        <button class="btn btn-link" onclick="goHomeAndShowRank()">ãƒ©ãƒ³ã‚­ãƒ³ã‚°è¡¨ã‚’ã¿ã‚‹</button>
      </div>
      <p>æ­£è§£æ•°: <strong>${score}</strong> / ${finished?TOTAL_QUESTIONS:answered}</p>
      <p>æ­£è§£ç‡: <strong>${percent}%</strong></p>
      <p>ã‹ã‹ã£ãŸæ™‚é–“: <strong>${totalTimeSec.toFixed(2)}ç§’</strong></p>`;

    if(!finished){
      html += `<p class="wrong">æ¬¡å›ã¯ã€å®Œèµ°ï¼ˆ${TOTAL_QUESTIONS}å•ãƒãƒ£ãƒ¬ãƒ³ã‚¸ï¼‰ã‚’ãŠå¾…ã¡ã—ã¦ã„ã¾ã™ï¼</p>`;
    }else{
      if(myRank && finishers){
        html += `<p class="rankLine">å®Œèµ°è€… <strong>${finishers}</strong> äººä¸­ <span class="rankEm">${myRank}</span> ä½</p>`;
      }else{
        html += `<p class="rankLine">å®Œèµ°è€…ã®é †ä½ã‚’é›†è¨ˆä¸­ã§ã™â€¦</p>`;
      }
    }

    if(canEditProfile && myDocId){
      html += `
        <hr>
        <h4>ãƒ©ãƒ³ã‚­ãƒ³ã‚°ç”¨ã®åå‰ãƒ»ã‚³ãƒ¡ãƒ³ãƒˆ</h4>
        <p>â€» ã‚³ãƒ¡ãƒ³ãƒˆã¯<strong>20æ–‡å­—ä»¥å†…</strong>ã§ã™</p>
        <div style="display:flex; gap:8px; flex-wrap:wrap; align-items:center; margin-bottom:8px;">
          <input id="nameInput" placeholder="åå‰ï¼ˆä»»æ„ï¼‰" style="padding:8px;border:1px solid #ccc;border-radius:8px;">
          <input id="commentInput" placeholder="ã‚³ãƒ¡ãƒ³ãƒˆï¼ˆ20æ–‡å­—ä»¥å†…ï¼‰" maxlength="20" style="flex:1;min-width:200px;padding:8px;border:1px solid #ccc;border-radius:8px;">
          <button class="btn btn-success" id="submitBtn">é€ä¿¡</button>
        </div>
        <div id="submitMsg" style="margin:4px 0 10px;"></div>
      `;
    }else if(finished){
      html += `<p style="margin:14px 0 0; color:#666;">â€» ä»Šå›ã¯TOP10å¤–ã®ãŸã‚ã€åå‰ãƒ»ã‚³ãƒ¡ãƒ³ãƒˆã®ç™»éŒ²ã¯ã§ãã¾ã›ã‚“ã€‚</p>`;
    }

    if(wrongList.length){
      html += `<h4>é–“é•ã£ãŸå•é¡Œ</h4>`;
      wrongList.forEach(x=>{
        html += `<div class="report-item">
          <div><strong>å•é¡Œ:</strong> ${esc(x.q)}</div>
          <div class="wrong"><strong>ã‚ãªãŸã®ç­”ãˆ:</strong> ${esc(x.your)}</div>
          <div class="correct"><strong>æ­£è§£:</strong> ${esc(x.right)}</div>
        </div>`;
      });
    }else if(finished){
      html += `<p class="correct">å…¨å•æ­£è§£ï¼ãŠã‚ã§ã¨ã†ã”ã–ã„ã¾ã™ï¼</p>`;
    }

    html += `
      <hr>
      <div style="display:flex; gap:8px; flex-wrap:wrap;">
        <button class="btn btn-secondary" onclick="goHome()">ã‚¹ã‚¿ãƒ¼ãƒˆç”»é¢ã«æˆ»ã‚‹</button>
        <button class="btn btn-link" onclick="goHomeAndShowRank()">ãƒ©ãƒ³ã‚­ãƒ³ã‚°è¡¨ã‚’ã¿ã‚‹</button>
      </div>
    `;

    const report = document.getElementById('finalReport');
    report.innerHTML = html;
    report.style.display = "block";

    if(canEditProfile && myDocId){
      const btn = document.getElementById('submitBtn');
      const msg = document.getElementById('submitMsg');
      btn.onclick = async ()=>{
        btn.disabled = true;
        const name = document.getElementById('nameInput').value || "";
        const comment = (document.getElementById('commentInput').value || "").slice(0,20);
        try{
          await db.collection('scores').doc(myDocId).update({ name, comment });
          msg.textContent = "é€ä¿¡ã—ã¾ã—ãŸã€‚ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã«åæ˜ ã—ã¾ã—ãŸã€‚";
          document.getElementById('nameInput').disabled = true;
          document.getElementById('commentInput').disabled = true;
          btn.style.display = "none";
          await renderTop10();
        }catch(e){
          console.error(e);
          msg.textContent = "é€ä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸã€‚æ™‚é–“ã‚’ãŠã„ã¦ãŠè©¦ã—ãã ã•ã„ã€‚";
          btn.disabled = false;
        }
      };
    }
  }

  function goHome(){
    document.getElementById('countOverlay').style.display = "none";
    document.getElementById('finalReport').style.display = "none";
    document.getElementById('gameArea').style.display = "none";
    document.getElementById('startArea').style.display = "block";
    document.getElementById('startButton').disabled = false;
  }
  async function goHomeAndShowRank(){
    goHome();
    await renderTop10();
    window.scrollTo({ top:0, behavior:'smooth' });
  }

  /* èµ·å‹• */
  document.addEventListener('DOMContentLoaded', renderTop10);
  </script>

  <footer>
    <div class="note">
      â€»P.E.I.P.ã¯è–éš·ã‚¯ãƒªã‚¹ãƒˆãƒ•ã‚¡ãƒ¼å¤§å­¦ã®ç¯ ï¨‘è‰¯å‹æ°ãŒä»‹è­·éç¨‹æ•™è‚²ã®è³ªå‘ä¸Šã®ãŸã‚ã«ä½œæˆã—ãŸæ•™æã§ã€è‘—ä½œæ¨©ã¯ç¯ ï¨‘è‰¯å‹æ°ã«ã‚ã‚Šã¾ã™ã€‚ãªãŠã€P.E.I.P.ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã§åˆ†é¡ã™ã‚‹å ´åˆã¯ã€å¿…ãšP.E.I.P.ã‚’å­¦ç¿’ã—ãŸä¸Šã§è¡Œã†ã‚ˆã†ã«ã—ã¦ãã ã•ã„ã€‚
    </div>
  </footer>
</body>
</html>
