<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>P.E.I.P. 分類クイズ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <style>
    :root{
      --pink:#ff69b4;
      --badge:#e3f7ff;
      --badge-b:#5bc0de;
      --acc:#fff6e0;
      --acc-b:#f0ad4e;
    }
    body { font-family: sans-serif; text-align: center; background:#f7f7f7; padding:26px; margin:0; }
    h1 { color:#444; margin:10px 0 12px; }

    /* 音声ON/OFF */
    .topbar { display:flex; gap:10px; justify-content:center; align-items:center; flex-wrap:wrap; margin-bottom:8px; }
    .sound-toggle { display:inline-flex; align-items:center; gap:8px; padding:6px 10px; border-radius:999px; background:#fff; border:1px solid #ddd; }
    .sound-toggle input { width:20px; height:20px; }
    #soundLabel { font-weight:600; }

    /* スタートボタン */
    #startButton { background:var(--pink); color:#fff; font-size:20px; padding:15px 40px; border-radius:14px; border:none; cursor:pointer; }
    #backButton { background:#6c757d; color:#fff; font-size:16px; padding:10px 16px; border:none; border-radius:10px; cursor:pointer; position:fixed; left:12px; top:12px; }

    /* 情報バー */
    .info { font-size:18px; margin-top:10px; display:flex; gap:16px; align-items:center; justify-content:center; flex-wrap:wrap; }

    .elapsed-badge {
      display:inline-block; padding:6px 14px; border-radius:999px;
      background:var(--badge); border:2px solid var(--badge-b); color:#0b6d85;
      font-weight:800; letter-spacing:0.5px;
    }
    #elapsed { font-size:34px; }
    #elapsed .decimal { font-size:20px; vertical-align:super; }
    .acc-badge {
      display:inline-block; padding:6px 14px; border-radius:999px;
      background:var(--acc); border:2px solid var(--acc-b); color:#856404; font-weight:800;
    }

    .question { font-size:24px; margin:20px 0; }
    .buttons { margin:16px; display:flex; gap:12px; flex-wrap:wrap; justify-content:center; }
    .btn-circle{
      width: 32vw; height: 32vw; max-width: 140px; max-height: 140px;
      min-width: 106px; min-height: 106px;
      border-radius: 50%;
      display:flex; align-items:center; justify-content:center;
      padding: 10px;
      text-align:center; line-height:1.25;
      white-space:normal; word-break:keep-all;
      box-shadow: 0 4px 10px rgba(0,0,0,0.08);
      transition: transform .06s ease-out, filter .1s ease;
      border:none; cursor:pointer; color:#fff;
    }
    .btn-circle:active{ transform: scale(0.98); filter: brightness(0.96); }
    .btn-content{ display:flex; flex-direction:column; gap:2px; align-items:center; width:100%; }
    .line1{ font-weight:800; font-size:1.12em; }
    .line2,.line3{ font-weight:700; font-size:.85em; opacity:.95; }
    .P  { background:#e74c3c; }
    .E  { background:#3498db; }
    .I  { background:#f1c40f; color:#333; }
    .Ph { background:#2ecc71; }

    .result { font-size:20px; margin-top:12px; min-height:1.6em; }

    /* 操作ボタン */
    #controlButtons { margin-top:12px; display:flex; gap:14px; justify-content:center; flex-wrap:wrap; }
    #pauseButton { background:#ff9800; color:#fff; font-size:20px; padding:12px 24px; border-radius:12px; border:none; cursor:pointer; }
    #quitButton  { background:#dc3545; color:#fff; font-size:20px; padding:12px 24px; border-radius:12px; border:none; cursor:pointer; }

    /* レポート */
    .report { text-align:left; margin:16px auto; max-width:820px; background:#fff; border-radius:12px; padding:16px; box-shadow:0 4px 18px rgba(0,0,0,.06); }
    .report h3 { border-bottom:2px solid #eee; padding-bottom:6px; margin-top:0; }
    .report-item { margin-bottom:12px; }
    .wrong { color:#d9534f; }
    .correct { color:#2e7d32; }

    /* カウントダウン（フェードなし・拡大のみ） */
    #countOverlay{
      position:fixed; inset:0; display:none; align-items:center; justify-content:center;
      background:rgba(0,0,0,.65); color:#fff; z-index:9999;
      font-weight:900; text-shadow:0 4px 14px rgba(0,0,0,.6); user-select:none;
      font-size:120px;
    }
    #countText { display:block; }
    @keyframes popscale { 0%{transform:scale(.7);} 60%{transform:scale(1.15);} 100%{transform:scale(1);} }
    .pop { animation: popscale .35s ease-out; }

    /* スタート画面のランキング */
    .top10 { max-width:880px; margin:14px auto; background:#fff; border-radius:12px; box-shadow:0 4px 18px rgba(0,0,0,.06); text-align:left; padding:12px; }
    .top10 h3{ margin:4px 0 8px; }
    .top10 table{ width:100%; border-collapse:collapse; }
    .top10 th,.top10 td{ padding:8px 6px; border-bottom:1px solid #f1f1f1; }
    .crown{ font-size:34px; }      /* 大きめ王冠 */
    .crown.silver{ filter: grayscale(100%); }
    .crown.bronze{ filter: hue-rotate(300deg) saturate(1.1); }

    .helper { color:#777; font-size:13px; }

    /* ランキングを見るボタン（投稿後に表示） */
    .viewRankBtn { background:#28a745; color:#fff; border:none; border-radius:10px; padding:10px 14px; cursor:pointer; }

    /* スタート画面の枠 */
    .intro { max-width:900px; margin:0 auto 14px; }
  </style>
</head>
<body>
  <button id="backButton" onclick="goIntro()">← スタート画面に戻る</button>
  <h1>P.E.I.P. 分類クイズ</h1>

  <!-- 音声トグル（スタート前から表示） -->
  <div class="topbar">
    <label class="sound-toggle" title="効果音 ON/OFF">
      <input type="checkbox" id="soundToggle" checked />
      <span id="soundLabel">音声: ON</span>
    </label>
  </div>

  <!-- スタート画面（TOP10もここに表示） -->
  <div id="introPanel" class="intro">
    <p class="helper" style="margin:6px 0 16px;">完走者（50問解答）の中から<strong>タイムが短い順</strong>でTOP10を表示しています。</p>
    <button id="startButton" onclick="startCountdown()">スタート</button>
    <div id="startTop10" class="top10" style="margin-top:16px;">
      <h3>現在のランキング TOP10</h3>
      <div class="helper">（最新を取得中…）</div>
    </div>
  </div>

  <!-- 情報バー（開始後に表示） -->
  <div class="info" id="gameInfo" style="display:none;">
    <span>スコア: <strong id="score">0</strong></span>
    <span>問題: <strong id="questionNumber">0</strong> / <strong id="totalQuestions">0</strong></span>
    <span class="elapsed-badge">経過時間: <span id="elapsed">0<span class="decimal">.00</span></span> 秒</span>
    <span class="acc-badge">正解率: <strong id="accuracy">0.0%</strong></span>
  </div>

  <!-- 問題 -->
  <div class="question" id="question" style="display:none;">問題を読み込み中...</div>

  <!-- 回答ボタン（丸形・3行） -->
  <div class="buttons" id="answerButtons" style="display:none;">
    <button class="btn-circle P"  onclick="checkAnswer('P')">
      <span class="btn-content">
        <span class="line1">きもち</span>
        <span class="line2">Personality</span>
        <span class="line3">個人</span>
      </span>
    </button>
    <button class="btn-circle E"  onclick="checkAnswer('E')">
      <span class="btn-content">
        <span class="line1">まわり</span>
        <span class="line2">Environment</span>
        <span class="line3">環境</span>
      </span>
    </button>
    <button class="btn-circle I"  onclick="checkAnswer('I')">
      <span class="btn-content">
        <span class="line1">できること</span>
        <span class="line2">Independence</span>
        <span class="line3">自立</span>
      </span>
    </button>
    <button class="btn-circle Ph" onclick="checkAnswer('Ph')">
      <span class="btn-content">
        <span class="line1">からだ＆病気</span>
        <span class="line2">Physical</span>
        <span class="line3">身体</span>
      </span>
    </button>
  </div>

  <div class="result" id="result"></div>

  <!-- 一時停止/終了 -->
  <div id="controlButtons" style="display:none;">
    <button id="pauseButton" onclick="togglePause()">⏸ 一時停止</button>
    <button id="quitButton"  onclick="quitGame()">⏹ やめる</button>
  </div>

  <!-- 結果レポート -->
  <div id="finalReport" class="report" style="display:none;"></div>

  <!-- 効果音 -->
  <audio id="correctSound"   src="se_correct.mp3"  preload="auto"></audio>
  <audio id="wrongSound"     src="se_wrong.mp3"    preload="auto"></audio>
  <audio id="countdownSound" src="countdown.mp3"   preload="auto"></audio>

  <!-- カウントダウン表示 -->
  <div id="countOverlay"><span id="countText">3</span></div>

  <!-- Firebase SDK（compat版） -->
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>

  <script>
    /************ Firebase 設定（あなたの値に差し替え） ************/
    const firebaseConfig = {
      apiKey: "AIzaSyARGroRdf4DmJN5nOHdiVy-a9UCA1ruDPw",
      authDomain: "peip-quiz.firebaseapp.com",
      projectId: "peip-quiz",
      storageBucket: "peip-quiz.firebasestorage.app",
      messagingSenderId: "523666051548",
      appId: "1:523666051548:web:2a84fc0f2163872b2eff19",
      measurementId: "G-6049XMQEBK"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    /************ ラベル等 ************/
    const labelMap = { P:"きもち", E:"まわり", I:"できること", Ph:"からだ＆病気" };

    /************ 問題（50問） ************/
    const questions = [
      { text: "孫に会いたいと思っているか？", answer: "P" },
      { text: "洗濯物にしわはあるか？", answer: "E" },
      { text: "トイレで立位をとることができるか？", answer: "I" },
      { text: "便秘はないか？", answer: "Ph" },
      { text: "朝食の飲み物にこだわりはあるか？", answer: "P" },
      { text: "居室の手すりにぐらつきはないか？", answer: "E" },
      { text: "一人で歯磨きはできるか？", answer: "I" },
      { text: "むせこみはないか？", answer: "Ph" },
      { text: "デイサービスを楽しみにしているか？", answer: "P" },
      { text: "冷蔵庫の中に消費期限が過ぎた食品はないか？", answer: "E" },
      { text: "歩行器を使えば自立歩行はできるか？", answer: "I" },
      { text: "足にむくみはないか？", answer: "Ph" },
      { text: "好きな音楽は何か？", answer: "P" },
      { text: "洗面所の床は濡れていないか？", answer: "E" },
      { text: "トイレのボタンを操作することはできるか？", answer: "I" },
      { text: "肌は乾燥していないか？", answer: "Ph" },
      { text: "外出できるようになりたいという希望はあるか？", answer: "P" },
      { text: "居室のベッドは介助用ベッドか？", answer: "E" },
      { text: "自分で着替えはできるか？", answer: "I" },
      { text: "食欲の有無", answer: "Ph" },
      { text: "昔していた仕事は何か？", answer: "P" },
      { text: "今使用している福祉用具は何か？", answer: "E" },
      { text: "自分で電話をかけることができるか？", answer: "I" },
      { text: "視力はどの程度か？", answer: "Ph" },
      { text: "食べたいものはあるか？", answer: "P" },
      { text: "自宅で10ミリ以上の段差があるのはどこか？", answer: "E" },
      { text: "自分でお茶を入れて飲むことはできるか？", answer: "I" },
      { text: "夜間の頻尿の有無", answer: "Ph" },
      { text: "習慣となっていることは何か？", answer: "P" },
      { text: "介護保険制度で利用しているサービスは何か？", answer: "E" },
      { text: "朝の体操で体を動かすことはできているか？", answer: "I" },
      { text: "ふらつきはないか？", answer: "I" },
      { text: "趣味（編み物）を再開したいという思いはあるか？", answer: "P" },
      { text: "居室の温度・室温は？", answer: "E" },
      { text: "自分で食事を準備することはできるか？", answer: "I" },
      { text: "腰痛など体の痛みはないか？", answer: "Ph" },
      { text: "調味料にこだわりはあるか？", answer: "P" },
      { text: "テレビのボリュームはいくつか？", answer: "E" },
      { text: "自分で薬は管理できているか？", answer: "I" },
      { text: "まぶたに目やにはついていないか？", answer: "Ph" },
      { text: "どのような環境で寝たい思っているか？", answer: "P" },
      { text: "ベッドサイドにコールボタンなどの有無", answer: "E" },
      { text: "肘なしの椅子でも座位をとることはできているか？", answer: "I" },
      { text: "巻き爪はないか？", answer: "Ph" },
      { text: "何をしている時が幸せを感じる時か？", answer: "P" },
      { text: "近所の人との交流はあるか？", answer: "E" },
      { text: "買い物リストを自分で書くことはできるか？", answer: "I" },
      { text: "夜間に不眠の有無", answer: "Ph" },
      { text: "食事の際にこだわりの食器や場所はあるか？", answer: "P" },
      { text: "居室の換気状況", answer: "E" }
    ];

    /************ ランキング（TOP10：完走者・時間短い順） ************/
    async function fetchTop10ByTime(){
      // 並び順：time 昇順 → correct 降順 → createdAt 昇順（複合インデックス必須）
      const snap = await db.collection('scores')
        .orderBy('time', 'asc')
        .orderBy('correct', 'desc')
        .orderBy('createdAt', 'asc')
        .limit(200)    // まず200件取って
        .get();

      const list = [];
      snap.forEach(d => list.push({ id:d.id, ...d.data() }));

      // 50問完走者のみ対象（正解数は不問）
      const finished = list.filter(r => Number(r.total) === 50);
      return finished.slice(0, 10);
    }

    function formatYMDHM(iso){
      try{
        const d = new Date(iso);
        const z = n => String(n).padStart(2, '0');
        return `${d.getFullYear()}-${z(d.getMonth()+1)}-${z(d.getDate())} ${z(d.getHours())}:${z(d.getMinutes())}`;
      }catch{ return iso || ""; }
    }

    function escapeHtml(s){ return String(s).replace(/[&<>"'`=\/]/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;','/':'&#x2F;','=':'&#x3D;','`':'&#x60;'}[c])); }

    async function renderStartTop10(){
      const box = document.getElementById('startTop10');
      try{
        const rows = await fetchTop10ByTime();
        if(!rows.length){ box.innerHTML = `<h3>現在のランキング TOP10</h3><div class="helper">まだ記録がありません。</div>`; return; }
        const crown = (i)=>{
          if(i===0) return `<span class="crown">👑</span>`;
          if(i===1) return `<span class="crown silver">👑</span>`;
          if(i===2) return `<span class="crown bronze">👑</span>`;
          return `${i+1}`;
        };
        box.innerHTML = `
          <h3>現在のランキング TOP10</h3>
          <table>
            <thead>
              <tr><th style="text-align:right;">順位</th><th style="text-align:left;">名前</th><th style="text-align:right;">正解</th><th style="text-align:right;">タイム</th><th style="text-align:left;">日時</th><th style="text-align:left;">コメント</th></tr>
            </thead>
            <tbody>
            ${rows.map((r,i)=>`
              <tr>
                <td style="text-align:right;">${crown(i)}</td>
                <td>${escapeHtml(r.name||"名無し")}</td>
                <td style="text-align:right;">${Number(r.correct)||0}</td>
                <td style="text-align:right;">${Number(r.time).toFixed(2)}s</td>
                <td>${formatYMDHM(r.createdAtLocal)}</td>
                <td>${escapeHtml(r.comment||"")}</td>
              </tr>
            `).join('')}
            </tbody>
          </table>`;
      }catch(e){
        console.error(e);
        box.innerHTML = `<h3>現在のランキング TOP10</h3><div class="helper">取得に失敗しました。時間を置いて再読込してください。</div>`;
      }
    }

    /************ ユーティリティ ************/
    function shuffle(a){ for(let i=a.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]]; } }

    let current=0, score=0, wrongAnswers=[];
    let startTime=0, elapsedTimer=null;
    let paused=false, pauseStartTime=0, totalPausedTime=0;
    let penaltyTime = 0; // 不正解ペナルティ累計（ms）
    let soundEnabled = true;

    const soundToggle = document.getElementById('soundToggle');
    const soundLabel  = document.getElementById('soundLabel');
    soundToggle.addEventListener('change', ()=>{
      soundEnabled = soundToggle.checked;
      soundLabel.textContent = soundEnabled ? '音声: ON' : '音声: OFF';
    });

    /************ カウントダウン（実測マーカー） ************/
    const COUNTDOWN_MARKERS = [
      { time: 0.00, label: "3" },
      { time: 0.90, label: "2" },
      { time: 1.80, label: "1" },
      { time: 2.65, label: "スタート！" }
    ];
    const HOLD_AFTER_START = 1.80;
    const EPS = 0.015;

    function startCountdown(){
      // スタート画面（TOP10）を隠す
      document.getElementById('introPanel').style.display = 'none';

      const cd = document.getElementById("countdownSound");
      const overlay = document.getElementById("countOverlay");
      const text = document.getElementById("countText");

      // ゲームUI初期化（表示は beginGame 後に切替）
      document.getElementById("finalReport").style.display = "none";
      document.getElementById("gameInfo").style.display = "flex";
      document.getElementById("question").style.display = "none";
      document.getElementById("answerButtons").style.display = "none";
      document.getElementById("controlButtons").style.display = "none";
      document.getElementById("result").textContent = "";

      overlay.style.display = "flex";

      let idx = 0;
      const lastMarker = COUNTDOWN_MARKERS[COUNTDOWN_MARKERS.length-1].time;
      const endTime = lastMarker + HOLD_AFTER_START + 0.05;

      const showLabel = (s)=>{
        if (text.textContent === s) return;
        text.textContent = s;
        text.classList.remove('pop'); void text.offsetWidth;
        text.classList.add('pop');
      };

      const begin = ()=>{
        const startTs = performance.now();

        if (soundEnabled) {
          try { cd.currentTime = 0; cd.play().catch(()=>{}); } catch(e){}

          const tick = ()=>{
            const elapsed = (performance.now() - startTs)/1000;
            const t = cd.currentTime || elapsed;
            while (idx < COUNTDOWN_MARKERS.length && t + EPS >= COUNTDOWN_MARKERS[idx].time) {
              showLabel(COUNTDOWN_MARKERS[idx].label);
              idx++;
            }
            if (elapsed < endTime) { requestAnimationFrame(tick); }
            else { overlay.style.display = "none"; beginGame(); }
          };
          tick();

        } else {
          const tick = ()=>{
            const t = (performance.now() - startTs)/1000;
            while (idx < COUNTDOWN_MARKERS.length && t + EPS >= COUNTDOWN_MARKERS[idx].time) {
              showLabel(COUNTDOWN_MARKERS[idx].label);
              idx++;
            }
            if (t < endTime) { requestAnimationFrame(tick); }
            else { overlay.style.display = "none"; beginGame(); }
          };
          tick();
        }
      };

      if (cd.readyState < 1) {
        cd.addEventListener('loadedmetadata', begin, {once:true});
        setTimeout(()=>{ if (cd.readyState < 1) begin(); }, 400);
      } else {
        begin();
      }
    }

    /************ ゲーム本体 ************/
    function beginGame(){
      shuffle(questions);
      current=0; score=0; wrongAnswers=[];
      paused=false; pauseStartTime=0; totalPausedTime=0; penaltyTime=0;

      document.getElementById("totalQuestions").innerText = questions.length;
      document.getElementById("score").innerText = score;
      updateAccuracy(0);

      document.getElementById("question").style.display = "block";
      document.getElementById("answerButtons").style.display = "flex";
      document.getElementById("controlButtons").style.display = "flex";
      document.getElementById("result").textContent = "";

      startTime = Date.now();
      elapsedTimer = setInterval(updateElapsedTime, 50);

      showQuestion();
    }

    function updateElapsedTime(){
      const sec = (Date.now() - startTime - totalPausedTime + penaltyTime) / 1000;
      const intPart = Math.floor(sec);
      const decimalPart = (sec - intPart).toFixed(2).substring(1);
      document.getElementById("elapsed").innerHTML =
        `${intPart}<span class="decimal">${decimalPart}</span>`;
    }

    function showQuestion(){
      document.getElementById("question").innerText = questions[current].text;
      document.getElementById("questionNumber").innerText = current + 1;
      document.getElementById("result").innerText = "";
    }

    function playOnce(id){
      if(!soundEnabled) return;
      const el = document.getElementById(id);
      try{ el.currentTime = 0; el.play(); }catch(e){}
    }

    function checkAnswer(choice){
      if(paused) return;
      const correct = questions[current].answer;

      if(choice === correct){
        score++;
        document.getElementById("result").innerText = "⭕ 正解！";
        playOnce("correctSound");
      }else{
        document.getElementById("result").innerText = `❌ 不正解。正解は「${labelMap[correct]}」です。`;
        playOnce("wrongSound");
        wrongAnswers.push({
          question: questions[current].text,
          selected: labelMap[choice] || "（無回答）",
          correct:  labelMap[correct]
        });
        penaltyTime += 5000; // 不正解で5秒追加
        updateElapsedTime();
      }

      document.getElementById("score").innerText = score;
      updateAccuracy(current + 1);

      current++;
      if(current < questions.length){
        setTimeout(showQuestion, 1200);
      }else{
        clearInterval(elapsedTimer);
        showFinalReport();
      }
    }

    function updateAccuracy(answered){
      const totalAnswered = Math.max(answered ?? 0, current);
      const rate = totalAnswered > 0 ? ((score/totalAnswered)*100).toFixed(1) : "0.0";
      document.getElementById("accuracy").textContent = `${rate}%`;
    }

    function togglePause(){
      if(!paused){
        paused = true;
        pauseStartTime = Date.now();
        clearInterval(elapsedTimer);
        document.getElementById("pauseButton").textContent = "▶ 再開";
        document.getElementById("result").textContent = "⏸ 一時停止中";
      }else{
        paused = false;
        totalPausedTime += Date.now() - pauseStartTime;
        elapsedTimer = setInterval(updateElapsedTime, 50);
        document.getElementById("pauseButton").textContent = "⏸ 一時停止";
        document.getElementById("result").textContent = "";
      }
    }

    function quitGame(){
      if(confirm("ゲームを終了しますか？")){
        clearInterval(elapsedTimer);
        showFinalReport();
      }
    }

    function goIntro(){
      // 何をしていてもスタート画面へ
      try{ clearInterval(elapsedTimer); }catch{}
      document.getElementById('question').style.display = 'none';
      document.getElementById('answerButtons').style.display = 'none';
      document.getElementById('controlButtons').style.display = 'none';
      document.getElementById('gameInfo').style.display = 'none';
      document.getElementById('finalReport').style.display = 'none';
      document.getElementById('introPanel').style.display = 'block';
      // スタート画面のTOP10を更新
      renderStartTop10();
    }

    /************ 結果・投稿・ランキング表示 ************/
    function buildSubmitFormHTML(correct, elapsedSec) {
      return `
        <h3>結果発表</h3>
        <p>正解数: <strong>${correct}</strong> / ${questions.length}</p>
        <p>正解率: <strong>${((correct/questions.length)*100).toFixed(1)}%</strong></p>
        <p>かかった時間: <strong>${elapsedSec.toFixed(2)}秒</strong></p>
        <hr/>
        <h4>ランキング投稿（50問すべて解いた方）</h4>
        <p class="helper">※一言コメントは<strong>20文字以内</strong>。送信後は編集できません。</p>
        <div style="display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin-bottom:8px;">
          <input id="rankName" placeholder="お名前（任意）" style="padding:8px;border:1px solid #ccc;border-radius:8px;"/>
          <input id="rankComment" maxlength="20" placeholder="一言コメント（20文字以内）" style="flex:1;min-width:260px;padding:8px;border:1px solid #ccc;border-radius:8px;"/>
          <button id="rankSubmitBtn" class="viewRankBtn">コメント送信（確定）</button>
        </div>
        <div id="rankMessage" class="helper" style="margin:6px 0 10px;"></div>
        <div id="leaderboard" style="margin-top:10px;"></div>`;
    }

    async function submitScoreToFirestore({name, comment, correct, elapsedSec}){
      const now = new Date();
      const payload = {
        name: name || "名無し",
        comment: (comment || "").slice(0, 20),  // 20文字制限
        correct: Number(correct) || 0,
        total: questions.length,                // 完走判定用（50）
        time: Number(elapsedSec) || 0,
        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
        createdAtLocal: now.toISOString(),      // 保存はISO（秒あり）
        commentAtLocal: now.toISOString()       // コメント確定時刻（表示は分まで）
      };
      const docRef = await db.collection('scores').add(payload);
      return docRef.id;
    }

    async function fetchLeaderboardAndRank({myId}){
      const snap = await db.collection('scores')
        .orderBy('time','asc')
        .orderBy('correct','desc')
        .orderBy('createdAt','asc')
        .limit(1000)
        .get();
      const list=[]; snap.forEach(d=>list.push({id:d.id, ...d.data()}));
      const finished = list.filter(r => Number(r.total) === 50);
      let myRank=null;
      finished.forEach((r,i)=>{ if(r.id===myId) myRank=i+1; });
      return { myRank, top:finished.slice(0,10), total:finished.length };
    }

    function leaderboardHTML(rows, myRank, total){
      const crown = (i)=>{
        if(i===0) return `<span class="crown">👑</span>`;
        if(i===1) return `<span class="crown silver">👑</span>`;
        if(i===2) return `<span class="crown bronze">👑</span>`;
        return `${i+1}`;
      };
      return `
        <h4>ランキング（上位10件）</h4>
        <table style="width:100%;border-collapse:collapse;">
          <thead><tr style="background:#fafafa;"><th style="text-align:right;padding:6px;">順位</th><th style="padding:6px;text-align:left;">名前</th><th style="text-align:right;padding:6px;">正解</th><th style="text-align:right;padding:6px;">タイム</th><th style="padding:6px;text-align:left;">日時</th><th style="padding:6px;text-align:left;">コメント</th></tr></thead>
          <tbody>
            ${rows.map((r,i)=>`
              <tr>
                <td style="text-align:right;padding:6px;">${crown(i)}</td>
                <td style="padding:6px;">${escapeHtml(r.name||"名無し")}</td>
                <td style="text-align:right;padding:6px;">${Number(r.correct)||0}</td>
                <td style="text-align:right;padding:6px;">${Number(r.time).toFixed(2)}s</td>
                <td style="padding:6px;">${formatYMDHM(r.createdAtLocal)}</td>
                <td style="padding:6px;">${escapeHtml(r.comment||"")}</td>
              </tr>`).join('')}
          </tbody>
        </table>
        <p style="margin-top:8px;" class="helper">あなたの順位：<strong>${myRank ?? "（集計外）"}</strong> / 全${total}件</p>`;
    }

    async function wireUpRankSubmit(correct, elapsedSec){
      const btn = document.getElementById('rankSubmitBtn');
      const nameEl = document.getElementById('rankName');
      const cmtEl  = document.getElementById('rankComment');
      const msgEl  = document.getElementById('rankMessage');
      const boardEl= document.getElementById('leaderboard');
      if(!btn) return;

      btn.onclick = async ()=>{
        btn.disabled = true;
        const name = nameEl.value || "";
        const comment = cmtEl.value || "";
        try{
          const myId = await submitScoreToFirestore({ name, comment, correct, elapsedSec });

          // 入力はロック（編集不可）
          nameEl.disabled = true; cmtEl.disabled = true;
          msgEl.textContent = "送信しました。ランキングを集計中…";

          const { myRank, top, total } = await fetchLeaderboardAndRank({ myId });
          boardEl.innerHTML = leaderboardHTML(top, myRank, total);
          msgEl.textContent = "掲載しました。";
          // 「ランキングを見る」ボタンを出す
          const viewBtn = document.createElement('button');
          viewBtn.className = 'viewRankBtn';
          viewBtn.textContent = 'ランキングを見る';
          viewBtn.style.marginTop = '8px';
          viewBtn.onclick = async ()=>{
            msgEl.textContent = "最新を取得中…";
            const { myRank:mr, top:tp, total:tt } = await fetchLeaderboardAndRank({ myId });
            boardEl.innerHTML = leaderboardHTML(tp, mr, tt);
            msgEl.textContent = "更新しました。";
          };
          boardEl.parentElement.appendChild(viewBtn);

        }catch(e){
          console.error(e);
          msgEl.textContent = "送信に失敗しました。時間をおいて再度お試しください。";
          btn.disabled = false;
        }
      };
    }

    function showFinalReport(){
      document.getElementById("gameInfo").style.display = "none";
      document.getElementById("question").style.display = "none";
      document.getElementById("answerButtons").style.display = "none";
      document.getElementById("controlButtons").style.display = "none";

      const totalTimeSec = Number(((Date.now() - startTime - totalPausedTime + penaltyTime)/1000).toFixed(2));

      let html = buildSubmitFormHTML(score, totalTimeSec);

      // 間違い一覧
      if(wrongAnswers.length){
        html += `<hr/><h4>間違った問題一覧</h4>`;
        wrongAnswers.forEach(item=>{
          html += `<div class="report-item">
            <div><strong>問題:</strong> ${item.question}</div>
            <div class="wrong"><strong>あなたの答え:</strong> ${item.selected}</div>
            <div class="correct"><strong>正解:</strong> ${item.correct}</div>
          </div>`;
        });
      }else{
        html += `<p class="correct">全問正解！おめでとうございます！</p>`;
      }

      html += `<div style="margin-top:10px;"><button onclick="startCountdown()" style="background:var(--pink);color:#fff;font-size:18px;padding:12px 26px;border-radius:12px;border:none;cursor:pointer;">もう一度プレイ</button></div>`;

      const report=document.getElementById("finalReport");
      report.innerHTML=html;
      report.style.display="block";

      // 投稿ボタン動作を付ける
      wireUpRankSubmit(score, totalTimeSec);
    }

    /************ 初期表示：スタート画面のTOP10 ************/
    document.addEventListener('DOMContentLoaded', ()=>{
      soundEnabled = soundToggle.checked;
      renderStartTop10();
    });
  </script>
</body>
</html>
